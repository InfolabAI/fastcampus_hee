"""
ë³´ì•ˆ ìœ í‹¸ë¦¬í‹° í…ŒìŠ¤íŠ¸
- ì„œë²„ ì—†ì´ ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸.
"""
# =============================================================================
# ë³´ì•ˆ ìœ í‹¸ë¦¬í‹° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - CI íŒŒì´í”„ë¼ì¸ìš©
# =============================================================================
# ëª©ì : SQL Injection, XSS, ë¹„ë°€ë²ˆí˜¸ í•´ì‹±, ë‚œìˆ˜ ìƒì„±, ì´ë©”ì¼ ê²€ì¦ í…ŒìŠ¤íŠ¸
# íŠ¹ì§•: ì™¸ë¶€ ì„œë²„ ì˜ì¡´ì„± ì—†ì´ ì‹¤í–‰ ê°€ëŠ¥ (ìˆœìˆ˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸)
# ì‹¤í–‰: pytest Part3_CI_test/test_security_utils.py
# =============================================================================

import hashlib  # SHA256 í•´ì‹œ ìƒì„±ìš© (ë¹„ë°€ë²ˆí˜¸ í•´ì‹±)
import re  # ì •ê·œí‘œí˜„ì‹ (íŒ¨í„´ íƒì§€)
import secrets  # ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜ ìƒì„±


# =============================================================================
# í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ 1: ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸
# =============================================================================
class TestInputValidation:
    """ì…ë ¥ ê²€ì¦ í…ŒìŠ¤íŠ¸ - SQL Injection ë° XSS ê³µê²© íŒ¨í„´ íƒì§€"""

    def test_sql_injection_pattern_detection(self):
        """SQL Injection íŒ¨í„´ íƒì§€ - ìœ„í—˜í•œ SQL êµ¬ë¬¸ ê°ì§€"""
        # ìœ„í—˜í•œ SQL Injection íŒ¨í„´ë“¤ (OWASP Top 10)
        dangerous_patterns = [
            "' OR '1'='1",  # í•­ìƒ ì°¸ì¸ ì¡°ê±´ (ì¸ì¦ ìš°íšŒ)
            "'; DROP TABLE users;--",  # í…Œì´ë¸” ì‚­ì œ ê³µê²©
            "'; DELETE FROM users;--",  # ë°ì´í„° ì‚­ì œ ê³µê²©
            "admin'--",  # ì£¼ì„ìœ¼ë¡œ ì¡°ê±´ ë¬´ì‹œ
        ]

        # SQL Injection íƒì§€ ì •ê·œí‘œí˜„ì‹
        # íŒ¨í„´: (ë”°ì˜´í‘œ + SQL í‚¤ì›Œë“œ) ë˜ëŠ” (ë”°ì˜´í‘œ + SQL ì£¼ì„)
        sql_injection_regex = re.compile(
            r"('.*\b(OR|AND|DROP|DELETE|SELECT|INSERT|UPDATE)\b)|('.*--)",
            re.IGNORECASE,  # ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ë§¤ì¹­
        )

        # ëª¨ë“  ìœ„í—˜ íŒ¨í„´ì´ íƒì§€ë˜ì–´ì•¼ í•¨
        for pattern in dangerous_patterns:
            assert (
                sql_injection_regex.search(pattern) is not None
            ), f"Should detect: {pattern}"  # íƒì§€ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬

    def test_safe_input_passes(self):
        """ì•ˆì „í•œ ì…ë ¥ì€ í†µê³¼ - ì •ìƒ ì…ë ¥ ì˜¤íƒ ë°©ì§€"""
        # ì•ˆì „í•œ ì¼ë°˜ ì…ë ¥ë“¤ (SQL Injection ì•„ë‹˜)
        safe_inputs = [
            "john_doe",  # ì¼ë°˜ ì‚¬ìš©ìëª…
            "user@example.com",  # ì´ë©”ì¼ ì£¼ì†Œ
            "Hello World",  # ì¼ë°˜ í…ìŠ¤íŠ¸
            "12345",  # ìˆ«ì
        ]

        # ë™ì¼í•œ SQL Injection íƒì§€ ì •ê·œí‘œí˜„ì‹
        sql_injection_regex = re.compile(
            r"('.*\b(OR|AND|DROP|DELETE|SELECT|INSERT|UPDATE)\b)|('.*--)",
            re.IGNORECASE,
        )

        # ì•ˆì „í•œ ì…ë ¥ì€ íƒì§€ë˜ì§€ ì•Šì•„ì•¼ í•¨ (False Positive ë°©ì§€)
        for input_str in safe_inputs:
            assert (
                sql_injection_regex.search(input_str) is None
            ), f"Should pass: {input_str}"  # ì˜¤íƒ ì‹œ ì—ëŸ¬

    def test_xss_pattern_detection(self):
        """XSS íŒ¨í„´ íƒì§€ - Cross-Site Scripting ê³µê²© ê°ì§€"""
        # ìœ„í—˜í•œ XSS íŒ¨í„´ë“¤ (OWASP Top 10)
        dangerous_patterns = [
            "<script>alert('xss')</script>",  # ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì‚½ì…
            "<img src=x onerror=alert('xss')>",  # ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì•…ìš©
            "javascript:alert('xss')",  # javascript: URI ìŠ¤í‚´
        ]

        # XSS íƒì§€ ì •ê·œí‘œí˜„ì‹ - ì£¼ìš” ê³µê²© ë²¡í„° íƒì§€
        xss_regex = re.compile(r"<script|javascript:|onerror=|onclick=", re.IGNORECASE)

        # ëª¨ë“  XSS íŒ¨í„´ì´ íƒì§€ë˜ì–´ì•¼ í•¨
        for pattern in dangerous_patterns:
            assert xss_regex.search(pattern) is not None, f"Should detect: {pattern}"


# =============================================================================
# í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ 2: ë¹„ë°€ë²ˆí˜¸ í•´ì‹± í…ŒìŠ¤íŠ¸
# =============================================================================
class TestPasswordHashing:
    """ë¹„ë°€ë²ˆí˜¸ í•´ì‹± í…ŒìŠ¤íŠ¸ - SHA256 í•´ì‹œ í•¨ìˆ˜ íŠ¹ì„± ê²€ì¦"""

    def test_hash_is_deterministic(self):
        """ê°™ì€ ì…ë ¥ì— ëŒ€í•´ ê°™ì€ í•´ì‹œ ìƒì„± - ê²°ì •ì (Deterministic) íŠ¹ì„±"""
        password = "test_password_123"  # í…ŒìŠ¤íŠ¸ìš© ë¹„ë°€ë²ˆí˜¸
        salt = "fixed_salt_for_testing"  # ê³ ì • ì†”íŠ¸ (ë ˆì¸ë³´ìš° í…Œì´ë¸” ê³µê²© ë°©ì§€)

        # ë™ì¼í•œ ì…ë ¥ â†’ ë™ì¼í•œ í•´ì‹œ (ê²°ì •ì  í•¨ìˆ˜)
        hash1 = hashlib.sha256((password + salt).encode()).hexdigest()  # ì²« ë²ˆì§¸ í•´ì‹œ
        hash2 = hashlib.sha256((password + salt).encode()).hexdigest()  # ë‘ ë²ˆì§¸ í•´ì‹œ

        assert hash1 == hash2  # ê²°ì •ì : í•­ìƒ ê°™ì€ ê²°ê³¼

    def test_different_passwords_different_hashes(self):
        """ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ëŠ” ë‹¤ë¥¸ í•´ì‹œ ìƒì„± - ì¶©ëŒ ì €í•­ì„±(Collision Resistance)"""
        salt = "fixed_salt"  # ë™ì¼í•œ ì†”íŠ¸ ì‚¬ìš©

        # ë‹¤ë¥¸ ì…ë ¥ â†’ ë‹¤ë¥¸ í•´ì‹œ (ì¶©ëŒ ì €í•­ì„±)
        hash1 = hashlib.sha256(
            ("password1" + salt).encode()
        ).hexdigest()  # password1ì˜ í•´ì‹œ
        hash2 = hashlib.sha256(
            ("password2" + salt).encode()
        ).hexdigest()  # password2ì˜ í•´ì‹œ

        assert hash1 != hash2  # ë‹¤ë¥¸ ì…ë ¥ì€ ë‹¤ë¥¸ í•´ì‹œ ìƒì„±

    def test_hash_length(self):
        """SHA256 í•´ì‹œ ê¸¸ì´ í™•ì¸ (64ì) - ê³ ì • ê¸¸ì´ ì¶œë ¥"""
        password_hash = hashlib.sha256("test".encode()).hexdigest()  # hex ë¬¸ìì—´ë¡œ ë³€í™˜

        assert len(password_hash) == 64  # SHA256 = 256ë¹„íŠ¸ = 32ë°”ì´íŠ¸ = 64ì hex


# =============================================================================
# í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ 3: ë³´ì•ˆ ë‚œìˆ˜ ìƒì„± í…ŒìŠ¤íŠ¸
# =============================================================================
class TestSecureRandomGeneration:
    """ë³´ì•ˆ ë‚œìˆ˜ ìƒì„± í…ŒìŠ¤íŠ¸ - secrets ëª¨ë“ˆ (ì•”í˜¸í•™ì  ì•ˆì „ì„±)"""

    def test_token_uniqueness(self):
        """í† í° ê³ ìœ ì„± í…ŒìŠ¤íŠ¸ - ì¶©ëŒ ë°©ì§€"""
        # 100ê°œì˜ í† í° ìƒì„± (ê° 32ë°”ì´íŠ¸ = 256ë¹„íŠ¸ ì—”íŠ¸ë¡œí”¼)
        tokens = [secrets.token_hex(32) for _ in range(100)]
        unique_tokens = set(tokens)  # ì¤‘ë³µ ì œê±°í•œ ì§‘í•©

        # ëª¨ë“  í† í°ì´ ê³ ìœ í•´ì•¼ í•¨ (ì¶©ëŒ í™•ë¥  = ê±°ì˜ 0)
        assert len(tokens) == len(unique_tokens), "All tokens should be unique"

    def test_token_length(self):
        """í† í° ê¸¸ì´ í…ŒìŠ¤íŠ¸ - ì¶©ë¶„í•œ ì—”íŠ¸ë¡œí”¼ ë³´ì¥"""
        token = secrets.token_hex(32)  # 32ë°”ì´íŠ¸ = 256ë¹„íŠ¸ ë‚œìˆ˜

        assert len(token) == 64  # 32ë°”ì´íŠ¸ â†’ 64ì hex ë¬¸ìì—´

    def test_token_is_hexadecimal(self):
        """í† í°ì´ 16ì§„ìˆ˜ ë¬¸ìì—´ì¸ì§€ í™•ì¸ - ìœ íš¨í•œ í˜•ì‹ ê²€ì¦"""
        token = secrets.token_hex(16)  # 16ë°”ì´íŠ¸ í† í° ìƒì„±

        # ëª¨ë“  ë¬¸ìê°€ 16ì§„ìˆ˜(0-9, a-f)ì—¬ì•¼ í•¨
        assert all(c in "0123456789abcdef" for c in token)


# =============================================================================
# í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ 4: ì´ë©”ì¼ ê²€ì¦ í…ŒìŠ¤íŠ¸
# =============================================================================
class TestEmailValidation:
    """ì´ë©”ì¼ ê²€ì¦ í…ŒìŠ¤íŠ¸ - RFC 5321 ê¸°ë°˜ í˜•ì‹ ê²€ì¦"""

    def test_valid_emails(self):
        """ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹ - ì •ìƒ ì´ë©”ì¼ íŒ¨í„´ í†µê³¼"""
        # ë‹¤ì–‘í•œ ìœ íš¨ ì´ë©”ì¼ í˜•ì‹ë“¤
        valid_emails = [
            "user@example.com",  # ê¸°ë³¸ í˜•ì‹
            "user.name@example.com",  # ì (.) í¬í•¨ ë¡œì»¬ íŒŒíŠ¸
            "user+tag@example.co.kr",  # í”ŒëŸ¬ìŠ¤(+) íƒœê·¸ ë° êµ­ê°€ ë„ë©”ì¸
            "user123@sub.example.org",  # ìˆ«ì ë° ì„œë¸Œë„ë©”ì¸
        ]

        # ì´ë©”ì¼ ê²€ì¦ ì •ê·œí‘œí˜„ì‹ (RFC 5321 ê°„ì†Œí™” ë²„ì „)
        # ë¡œì»¬íŒŒíŠ¸@ë„ë©”ì¸.TLD í˜•ì‹
        email_regex = re.compile(r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$")

        # ëª¨ë“  ìœ íš¨ ì´ë©”ì¼ì´ í†µê³¼í•´ì•¼ í•¨
        for email in valid_emails:
            assert email_regex.match(email) is not None, f"Should be valid: {email}"

    def test_invalid_emails(self):
        """ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ - ì˜ëª»ëœ íŒ¨í„´ ê±°ë¶€"""
        # ë‹¤ì–‘í•œ ë¬´íš¨ ì´ë©”ì¼ í˜•ì‹ë“¤
        invalid_emails = [
            "userexample.com",  # @ ì—†ìŒ (í•„ìˆ˜ êµ¬ë¶„ì ëˆ„ë½)
            "user@",  # ë„ë©”ì¸ ì—†ìŒ
            "@example.com",  # ì‚¬ìš©ìëª… ì—†ìŒ (ë¡œì»¬ íŒŒíŠ¸ ëˆ„ë½)
            "user@.com",  # ë„ë©”ì¸ ì´ë¦„ ì—†ìŒ (ë¹ˆ ë„ë©”ì¸)
        ]

        # ë™ì¼í•œ ì´ë©”ì¼ ê²€ì¦ ì •ê·œí‘œí˜„ì‹
        email_regex = re.compile(r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$")

        # ëª¨ë“  ë¬´íš¨ ì´ë©”ì¼ì´ ê±°ë¶€ë˜ì–´ì•¼ í•¨
        for email in invalid_emails:
            assert email_regex.match(email) is None, f"Should be invalid: {email}"


# =============================================================================
# ğŸš¨ ì˜ë„ì  ì—ëŸ¬ ì„¹ì…˜ (Deliberate Errors for CI Demonstration)
# =============================================================================
# ì•„ë˜ ì½”ë“œì˜ ì£¼ì„ì„ í•´ì œí•˜ë©´ CI íŒŒì´í”„ë¼ì¸ì—ì„œ ë‹¤ì–‘í•œ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.
# í•™ìŠµ ëª©ì ìœ¼ë¡œ ì£¼ì„ì„ í•´ì œí•˜ê³  CI ì‹¤íŒ¨ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.
#
# ì£¼ì„ í•´ì œ ë°©ë²•: ê° ì„¹ì…˜ì˜ ì½”ë“œ ì• '#'ì„ ì œê±°
# ë³µì› ë°©ë²•: ë‹¤ì‹œ '#'ì„ ì¶”ê°€í•˜ê±°ë‚˜ git checkoutìœ¼ë¡œ ë³µì›
# =============================================================================

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 1: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” import (flake8 F401)
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: F401 'os' imported but unused
# -----------------------------------------------------------------------------
# import os  # noqa: F401 - ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” import

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 2: ë¹ˆ ì¤„ ë¶€ì¡± (flake8 E302)
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: E302 expected 2 blank lines, found 1
# ì•„ë˜ í•¨ìˆ˜ ìœ„ì— ë¹ˆ ì¤„ì´ 1ê°œë§Œ ìˆì–´ì„œ ì—ëŸ¬ ë°œìƒ
# -----------------------------------------------------------------------------
# def deliberate_e302_error():
#     """ë¹ˆ ì¤„ ë¶€ì¡± ì—ëŸ¬ ë°ëª¨"""
#     pass

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 3: ì¤„ ê¸¸ì´ ì´ˆê³¼ (flake8 E501)
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: E501 line too long (150 > 120 characters)
# -----------------------------------------------------------------------------
# long_var = "This line is intentionally very long to trigger E501 error when uncommented, exceeding 120 chars limit"

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 4: f-string í”Œë ˆì´ìŠ¤í™€ë” ëˆ„ë½ (flake8 F541)
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: F541 f-string is missing placeholders
# -----------------------------------------------------------------------------
# def deliberate_f541_error():
#     result = f"This f-string has no placeholders"  # noqa: F541
#     return result

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 5: í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ (bandit B105)
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: B105 hardcoded_password_string
# -----------------------------------------------------------------------------
# HARDCODED_PASSWORD = "super_secret_password_123"  # nosec B105

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 6: eval ì‚¬ìš© (bandit B307)
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: B307 Use of possibly insecure function
# -----------------------------------------------------------------------------
# def deliberate_b307_error(user_input):
#     """eval ì‚¬ìš© ë³´ì•ˆ ì—ëŸ¬ ë°ëª¨"""
#     return eval(user_input)  # nosec B307

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 7: exec ì‚¬ìš© (bandit B102)
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: B102 Use of exec detected
# -----------------------------------------------------------------------------
# def deliberate_b102_error(code):
#     """exec ì‚¬ìš© ë³´ì•ˆ ì—ëŸ¬ ë°ëª¨"""
#     exec(code)  # nosec B102

# -----------------------------------------------------------------------------
# ì—ëŸ¬ 8: assert ë¬¸ ì‚¬ìš© (bandit B101) - í…ŒìŠ¤íŠ¸ ì™¸ë¶€ì—ì„œ
# -----------------------------------------------------------------------------
# ì£¼ì„ í•´ì œ ì‹œ ì—ëŸ¬: B101 Use of assert detected
# -----------------------------------------------------------------------------
# def deliberate_b101_error(value):
#     """assert ì‚¬ìš© ë³´ì•ˆ ì—ëŸ¬ ë°ëª¨ (í”„ë¡œë•ì…˜ ì½”ë“œì—ì„œ)"""
#     assert value > 0, "Value must be positive"  # nosec B101
#     return value
