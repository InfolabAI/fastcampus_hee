# =============================================================================
# CI (Continuous Integration) Workflow
# =============================================================================
# 이 워크플로우는 코드 품질을 자동으로 검증합니다.
# 실행 시점: push, pull request, 수동 실행
# =============================================================================

name: CI

# -----------------------------------------------------------------------------
# 트리거 설정 (Trigger Configuration)
# -----------------------------------------------------------------------------
# on: 워크플로우가 언제 실행될지 정의
#
# push.branches: 특정 브랜치에 코드가 푸시될 때 실행
# pull_request.branches: 해당 브랜치를 대상으로 하는 PR에서 실행
# workflow_dispatch: GitHub UI에서 수동 실행 가능 (Actions 탭 > Run workflow)
# -----------------------------------------------------------------------------
on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

# -----------------------------------------------------------------------------
# Jobs 정의
# -----------------------------------------------------------------------------
# jobs: 워크플로우에서 실행할 작업들을 정의
# 각 job은 독립적인 가상 머신(runner)에서 실행됨
# -----------------------------------------------------------------------------
jobs:

  # ===========================================================================
  # Job 1: lint (코드 스타일 검사)
  # ===========================================================================
  # Python 코드의 스타일과 포맷을 검사합니다.
  #
  # runs-on: 실행 환경 지정
  #   - ubuntu-latest: GitHub 제공 최신 Ubuntu VM
  #   - 다른 옵션: windows-latest, macos-latest, self-hosted
  #
  # steps: 순서대로 실행할 단계들
  # ===========================================================================
  lint:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------------------------
      # Step 1: 소스 코드 체크아웃
      # -----------------------------------------------------------------------
      # uses: 미리 만들어진 Action 사용
      # actions/checkout@v4: GitHub 공식 체크아웃 액션 (버전 4)
      #   - 현재 레포지토리의 코드를 러너에 복사
      # -----------------------------------------------------------------------
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Python 환경 설정
      # -----------------------------------------------------------------------
      # actions/setup-python@v5: Python 설치 및 설정 액션
      #
      # with: 액션에 전달할 파라미터
      #   python-version: 설치할 Python 버전 (3.11.x 최신)
      #   cache: 'pip' - pip 패키지 캐싱으로 속도 향상
      # -----------------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # -----------------------------------------------------------------------
      # Step 3: 린트 도구 설치
      # -----------------------------------------------------------------------
      # flake8: Python 코드 스타일 검사 (PEP8 준수 확인)
      # black: Python 코드 자동 포맷터 (일관된 스타일)
      # isort: Python import 문 정렬 도구
      # -----------------------------------------------------------------------
      - name: Install lint tools
        run: pip install flake8 black isort

      # -----------------------------------------------------------------------
      # Step 4: flake8 실행 (코드 스타일 검사)
      # -----------------------------------------------------------------------
      # --max-line-length=120: 한 줄 최대 길이 (기본값: 79)
      # --exclude: 검사 제외 디렉토리
      # . : 현재 디렉토리 전체 검사
      # -----------------------------------------------------------------------
      - name: Run flake8
        run: flake8 --max-line-length=120 Part3_CI_test/

      # -----------------------------------------------------------------------
      # Step 5: black 포맷 검사
      # -----------------------------------------------------------------------
      # --check: 실제 수정 없이 검사만 (위반 시 에러)
      # --exclude: 제외 디렉토리 (정규식 패턴)
      # -----------------------------------------------------------------------
      - name: Check black formatting
        run: black --check Part3_CI_test/

      # -----------------------------------------------------------------------
      # Step 6: import 정렬 검사
      # -----------------------------------------------------------------------
      # --check-only: 실제 수정 없이 검사만
      # --skip: 제외할 디렉토리
      # -----------------------------------------------------------------------
      - name: Check import sorting
        run: isort --check-only Part3_CI_test/

  # ===========================================================================
  # Job 2: test (테스트 실행)
  # ===========================================================================
  # pytest를 사용하여 단위 테스트를 실행합니다.
  #
  # needs: lint job이 성공한 후에만 실행
  #   - lint 실패 시 test는 실행되지 않음 (리소스 절약)
  # ===========================================================================
  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # -----------------------------------------------------------------------
      # Step: 테스트 의존성 설치
      # -----------------------------------------------------------------------
      # pytest: Python 테스트 프레임워크
      # pytest-cov: 코드 커버리지 플러그인
      # pyjwt: JWT 토큰 처리 (test_jwt_validation.py에서 사용)
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: pip install pytest pytest-cov pyjwt

      # -----------------------------------------------------------------------
      # Step: 테스트 실행
      # -----------------------------------------------------------------------
      # Part3_CI_test/: CI용 테스트만 실행 (서버 불필요)
      # --cov=Part3_CI_test: 해당 폴더 커버리지 측정
      # --cov-report=term-missing: 터미널에 미커버 라인 표시
      # -v: verbose 모드 (상세 출력)
      # -----------------------------------------------------------------------
      - name: Run tests
        run: pytest Part3_CI_test/ --cov=Part3_CI_test --cov-report=term-missing -v

  # ===========================================================================
  # Job 3: security (보안 스캔)
  # ===========================================================================
  # bandit으로 Python 코드 보안 취약점 검사
  # 이 job은 lint, test와 병렬 실행 (needs 없음)
  # ===========================================================================
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -----------------------------------------------------------------------
      # bandit: Python 보안 취약점 스캐너 (OWASP 패턴 검사)
      # -----------------------------------------------------------------------
      - name: Install bandit
        run: pip install bandit

      # -----------------------------------------------------------------------
      # Step: 보안 스캔 실행
      # -----------------------------------------------------------------------
      # -r .: 재귀적 스캔
      # -x: 제외 디렉토리
      # -f json: JSON 형식 출력
      # -o: 결과 파일 저장
      # -ll: Low level 이상 취약점 표시
      # || true: 취약점 발견해도 계속 진행
      # -----------------------------------------------------------------------
      - name: Run security scan
        run: |
          bandit -r Part3_CI_test/ --skip B101 -f json -o bandit-report.json || true
          bandit -r Part3_CI_test/ --skip B101 -ll

      # -----------------------------------------------------------------------
      # Step: 보안 리포트 업로드
      # -----------------------------------------------------------------------
      # actions/upload-artifact: 파일을 아티팩트로 업로드
      #   - 워크플로우 완료 후에도 다운로드 가능
      # if: always() - 성공/실패 관계없이 항상 실행
      # -----------------------------------------------------------------------
      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json

  # ===========================================================================
  # Job 4: docker (Docker 이미지 빌드)
  # ===========================================================================
  # Docker 이미지 빌드 및 동작 확인
  #
  # needs: [lint, test] - 둘 다 성공해야 실행
  # ===========================================================================
  docker:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Docker Buildx 설정
      # -----------------------------------------------------------------------
      # docker/setup-buildx-action: Buildx 설치
      #   - 멀티 플랫폼 빌드 (amd64, arm64)
      #   - 빌드 캐싱
      #   - BuildKit 고급 기능
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Step: Docker 이미지 빌드
      # -----------------------------------------------------------------------
      # docker build: 이미지 빌드
      # -t: 태그 설정 (이미지명:태그)
      # ${{ github.sha }}: 현재 커밋 SHA 해시
      # -f: Dockerfile 경로 지정
      # . : 빌드 컨텍스트 (현재 디렉토리)
      # -----------------------------------------------------------------------
      - name: Build Docker image
        run: |
          docker build -t fastcampus:${{ github.sha }} \
            -f .devcontainer/Dockerfile.integrated .

      # -----------------------------------------------------------------------
      # Step: Docker 이미지 테스트
      # -----------------------------------------------------------------------
      # docker run: 컨테이너 실행
      # --rm: 종료 후 자동 삭제
      # python --version: 스모크 테스트 (Python 설치 확인)
      # -----------------------------------------------------------------------
      - name: Test Docker image
        run: |
          docker run --rm fastcampus:${{ github.sha }} python --version
