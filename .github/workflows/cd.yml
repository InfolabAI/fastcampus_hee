# =============================================================================
# CD (Continuous Deployment) Workflow
# =============================================================================
# 이 워크플로우는 Docker 이미지를 빌드하고 배포합니다.
# 실행 시점: 버전 태그 push (v*), 수동 실행
# =============================================================================

name: CD

# -----------------------------------------------------------------------------
# 트리거 설정 (Trigger Configuration)
# -----------------------------------------------------------------------------
# push.tags: 특정 패턴의 태그가 푸시될 때 실행
#   - 'v*': v로 시작하는 모든 태그 (예: v1.0.0, v2.1.3-beta)
#
# workflow_dispatch: 수동 실행 설정
#   inputs: 사용자 입력 정의
#     type: choice - 드롭다운 선택 메뉴
#     required: true - 필수 입력
#     default: 기본값
# -----------------------------------------------------------------------------
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# -----------------------------------------------------------------------------
# 환경 변수 (Environment Variables)
# -----------------------------------------------------------------------------
# env: 워크플로우 전체에서 사용할 환경 변수
# 모든 job/step에서 ${{ env.변수명 }}으로 접근
#
# REGISTRY: Docker 레지스트리 주소
#   - ghcr.io: GitHub Container Registry (무료)
# IMAGE_NAME: Docker 이미지 이름
#   - ${{ github.repository }}: owner/repo-name 형식
# -----------------------------------------------------------------------------
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:

  # ===========================================================================
  # Job 1: build-and-push (Docker 이미지 빌드 및 푸시)
  # ===========================================================================
  # Docker 이미지를 빌드하고 GitHub Container Registry에 푸시합니다.
  #
  # permissions: GITHUB_TOKEN 권한 설정 (최소 권한 원칙)
  #   contents: read - 코드 읽기 (체크아웃)
  #   packages: write - GHCR 쓰기 (이미지 푸시)
  # ===========================================================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Docker Buildx 설정
      # -----------------------------------------------------------------------
      # docker/setup-buildx-action: Buildx 설치
      #   - 멀티 플랫폼 빌드 (amd64, arm64)
      #   - 빌드 캐싱
      #   - BuildKit 고급 기능
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # GitHub Container Registry 로그인
      # -----------------------------------------------------------------------
      # docker/login-action: 레지스트리 인증
      #   registry: 로그인할 레지스트리 (ghcr.io)
      #   username: ${{ github.actor }} - 워크플로우 실행자
      #   password: ${{ secrets.GITHUB_TOKEN }} - 자동 생성 토큰
      # -----------------------------------------------------------------------
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Docker 메타데이터 추출
      # -----------------------------------------------------------------------
      # docker/metadata-action: 태그/라벨 자동 생성
      #   id: meta - 출력을 다른 스텝에서 참조 (${{ steps.meta.outputs.* }})
      #
      # tags 규칙:
      #   type=semver,pattern={{version}} - v1.2.3 → 1.2.3
      #   type=semver,pattern={{major}}.{{minor}} - v1.2.3 → 1.2
      #   type=sha,prefix= - 커밋 SHA (7자리)
      # -----------------------------------------------------------------------
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=

      # -----------------------------------------------------------------------
      # Docker 이미지 빌드 및 푸시
      # -----------------------------------------------------------------------
      # docker/build-push-action: 빌드 + 푸시 통합 액션
      #   context: 빌드 컨텍스트 (현재 디렉토리)
      #   file: Dockerfile 경로
      #   push: true - 레지스트리에 푸시
      #   tags/labels: metadata-action 출력 사용
      #   cache-from/to: GitHub Actions 캐시로 빌드 속도 향상
      # -----------------------------------------------------------------------
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: .devcontainer/Dockerfile.integrated
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Job 2: deploy-staging (스테이징 환경 배포)
  # ===========================================================================
  # 스테이징 환경에 배포합니다 (테스트/검증 목적)
  #
  # needs: build-and-push 성공 후 실행
  #
  # if: 조건부 실행
  #   - 수동 실행 시 'staging' 선택
  #   - 또는 v* 태그 푸시 (자동 스테이징 배포)
  #
  # environment: GitHub 환경 설정
  #   - Repository Settings > Environments에서 설정
  #   - 환경별 시크릿, 보호 규칙, 배포 히스토리 관리
  # ===========================================================================
  deploy-staging:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging' || startsWith(github.ref, 'refs/tags/v')
    environment: staging

    steps:
      # -----------------------------------------------------------------------
      # 스테이징 배포 실행
      # -----------------------------------------------------------------------
      # 실제 배포 시 아래 echo를 실제 명령어로 교체:
      #   - kubectl set image deployment/app ...
      #   - docker-compose -f docker-compose.staging.yml up -d
      #   - ssh user@server "docker pull ... && docker-compose up -d"
      # -----------------------------------------------------------------------
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

  # ===========================================================================
  # Job 3: deploy-production (프로덕션 환경 배포)
  # ===========================================================================
  # 프로덕션 환경에 배포합니다 (실제 서비스)
  #
  # needs: [build-and-push, deploy-staging]
  #   - 빌드 성공 + 스테이징 배포 성공 후 실행
  #
  # if: 수동 실행에서 'production' 선택한 경우만
  #   - 태그 푸시로는 자동 프로덕션 배포 안됨 (안전장치)
  #
  # environment: production
  #   - GitHub에서 보호 규칙 설정 권장:
  #     * Required reviewers (승인자 지정)
  #     * Wait timer (대기 시간)
  #     * Deployment branches (허용 브랜치)
  # ===========================================================================
  deploy-production:
    needs: [build-and-push, deploy-staging]
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    environment: production

    steps:
      # -----------------------------------------------------------------------
      # 프로덕션 배포 실행
      # -----------------------------------------------------------------------
      # 실제 배포 시 아래 echo를 실제 명령어로 교체:
      #   - kubectl set image ... --record && kubectl rollout status ...
      #   - aws ecs update-service --cluster production ...
      #   - helm upgrade app ./charts/app --set image.tag=...
      # -----------------------------------------------------------------------
      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
