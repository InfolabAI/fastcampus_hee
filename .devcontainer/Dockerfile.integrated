# Phase 1 MCP ë³´ì•ˆ êµìœ¡ - ê°„ì†Œí™”ëœ í†µí•© í™˜ê²½
# ê¸°ì¡´ Dockerfileì„ ê¸°ë°˜ìœ¼ë¡œ ìµœì†Œí•œì˜ ë³´ì•ˆ ì‹¤ìŠµ ë„êµ¬ë§Œ ì¶”ê°€

FROM mcr.microsoft.com/devcontainers/python:3.11-bullseye

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1

# 1. í•„ìˆ˜ ë³´ì•ˆ ì‹¤ìŠµ ë„êµ¬ë§Œ ì„¤ì¹˜ (ìµœì†Œí™”)
RUN sudo apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && sudo apt-get -y install --no-install-recommends \
    # ê¸°ì¡´ ë„êµ¬ ìœ ì§€
    git docker.io \
    # ë³´ì•ˆ ì‹¤ìŠµ í•„ìˆ˜ ë„êµ¬ë§Œ ì¶”ê°€
    curl jq \
    # ê°„ë‹¨í•œ ê³µê²© ì‹œë®¬ë ˆì´ì…˜ìš©
    nmap \
    && sudo usermod -aG docker vscode \
    && sudo apt-get clean \
    && sudo rm -rf /var/lib/apt/lists/*

# 2. Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ê¸°ì¡´ + ë³´ì•ˆ ì‹¤ìŠµ í•„ìˆ˜)
RUN pip install --no-cache-dir \
    # ê¸°ì¡´ íŒ¨í‚¤ì§€
    fastapi==0.116.1 \
    uvicorn==0.35.0 \
    httpx==0.28.1 \
    pydantic==2.11.7 \
    python-dotenv==1.1.1 \
    fastmcp==2.11.2 \
    # ë³´ì•ˆ ì‹¤ìŠµ í•„ìˆ˜ íŒ¨í‚¤ì§€ë§Œ ì¶”ê°€
    PyJWT==2.8.0 \
    python-json-logger==2.0.7 \
    aiohttp==3.9.1 \
    pytest==8.4.2

# 3. nvmê³¼ Node.js ì„¤ì¹˜
# nvm ì„¤ì¹˜ë¥¼ ìœ„í•œ í™˜ê²½ ì„¤ì •
ENV NVM_DIR="/home/vscode/.nvm"
ENV NODE_VERSION="22"

# vscode ì‚¬ìš©ìë¡œ nvm ë° Node.js ì„¤ì¹˜
USER vscode
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash && \
    . "$NVM_DIR/nvm.sh" && \
    nvm install $NODE_VERSION && \
    nvm alias default $NODE_VERSION && \
    nvm use default

# PATHì— Node.js ì¶”ê°€
ENV PATH="$NVM_DIR/versions/node/v$NODE_VERSION/bin:$PATH"

# rootë¡œ ëŒì•„ê°€ì„œ ë‚˜ë¨¸ì§€ ì„¤ì • ìˆ˜í–‰
USER root

# 4. ì‹¤ìŠµ ë””ë ‰í† ë¦¬ ìƒì„±
RUN sudo mkdir -p /scripts /server /logs && \
    sudo chown -R vscode:vscode /scripts /server /logs

# 5. ê°„ë‹¨í•œ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
RUN echo '#!/bin/bash\n\
    echo "âœ… ì‹¤ìŠµ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ!"\n\
    echo "ğŸ“š Node.js ë²„ì „: $(node -v)"\n\
    echo "ğŸ“š npm ë²„ì „: $(npm -v)"\n\
    echo "ğŸ“š python3 /scripts/security_demo.py ë¡œ ì‹¤ìŠµì„ ì‹œì‘í•˜ì„¸ìš”."' > /scripts/start_services.sh && \
    chmod +x /scripts/start_services.sh

# 7. ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /workspaces/fastcampus

# 8. í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8080 8081 9200

# 9. ê¸°ë³¸ ëª…ë ¹ì–´
CMD ["sleep", "infinity"]