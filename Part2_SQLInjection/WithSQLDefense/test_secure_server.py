#!/usr/bin/env python3
"""
===========================================
ë³´ì•ˆ ì„œë²„ í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸
===========================================

ê°•ì˜ ëª©ì :
ì´ íŒŒì¼ì€ ë³´ì•ˆì´ ì ìš©ëœ SQL ì„œë²„ì˜ 'ì •ìƒì ì¸' ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
Prepared Statementì™€ ì…ë ¥ ê²€ì¦ì´ ì •ìƒ ë™ì‘ì—ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŒì„ í™•ì¸í•©ë‹ˆë‹¤.

í•™ìŠµ í¬ì¸íŠ¸:
1. ë³´ì•ˆ ì„œë²„ë„ ì •ìƒ ì…ë ¥ì€ ë¬¸ì œì—†ì´ ì²˜ë¦¬
2. test_vulnerable_server.pyì™€ ë™ì¼í•œ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
3. ë³´ì•ˆ ê¸°ëŠ¥ì´ ì‚¬ìš©ì ê²½í—˜ì„ í•´ì¹˜ì§€ ì•ŠìŒ
4. ì •ìƒ vs ë¹„ì •ìƒ ì…ë ¥ì˜ êµ¬ë¶„

ë¹„êµ:
- test_vulnerable_server.py: ì·¨ì•½í•œ ì„œë²„ í…ŒìŠ¤íŠ¸
- test_secure_server.py: ë³´ì•ˆ ì„œë²„ í…ŒìŠ¤íŠ¸ (ì´ íŒŒì¼)
- ë‘ íŒŒì¼ ëª¨ë‘ ì •ìƒ ì…ë ¥ë§Œ ì‚¬ìš©
- secure_attack_simulation.pyì—ì„œ ê³µê²© ì°¨ë‹¨ í™•ì¸
"""

# ===========================================
# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸
# ===========================================

import asyncio  # ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°
import json     # JSON ë°ì´í„° ì²˜ë¦¬ (ì‚¬ìš© ì•ˆ í•˜ì§€ë§Œ importë¨)
import sys      # stdout flushë¥¼ ìœ„í•´ ì¶”ê°€
# MCP í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
from mcp import ClientSession, StdioServerParameters
from mcp.client.stdio import stdio_client

# ===========================================
# ë©”ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
# ===========================================

async def test_secure_server():
    """
    ë³´ì•ˆ ì„œë²„ì˜ ì •ìƒ ë™ì‘ í…ŒìŠ¤íŠ¸

    í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:
    1. ì •ìƒ ë¡œê·¸ì¸ - ì˜¬ë°”ë¥¸ ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸
    2. ì‚¬ìš©ì ê²€ìƒ‰ - ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰
    3. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ - IDë¡œ ì¡°íšŒ
    4. ì´ë©”ì¼ ì—…ë°ì´íŠ¸ - ìœ íš¨í•œ ì´ë©”ì¼ë¡œ ë³€ê²½
    5. ì—…ë°ì´íŠ¸ í™•ì¸ - ë³€ê²½ì‚¬í•­ ê²€ì¦

    ì¤‘ìš”:
    - ëª¨ë“  ì…ë ¥ì€ 'ì •ìƒì 'ì´ê³  ìœ íš¨í•¨
    - ê³µê²© ì‹œë„ëŠ” ì—†ìŒ
    - ë³´ì•ˆ ì„œë²„ê°€ ì •ìƒ ì…ë ¥ì„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸
    - test_vulnerable_server.pyì™€ ê±°ì˜ ë™ì¼í•œ í…ŒìŠ¤íŠ¸
    """

    # í…ŒìŠ¤íŠ¸ ì‹œì‘ í—¤ë”
    print("=" * 70)
    print("ğŸ§ª ë³´ì•ˆ SQL ì„œë²„ - ì •ìƒ ë™ì‘ í…ŒìŠ¤íŠ¸")
    print("=" * 70)

    # ===========================================
    # ì„œë²„ ì‹¤í–‰ íŒŒì¼ ê²½ë¡œ ì„¤ì •
    # ===========================================
    import os
    script_dir = os.path.dirname(os.path.abspath(__file__))

    # ===========================================
    # MCP ì„œë²„ íŒŒë¼ë¯¸í„° ì„¤ì •
    # ===========================================
    # secure_server.pyë¥¼ subprocessë¡œ ì‹¤í–‰
    server_params = StdioServerParameters(
        command="python3",
        args=[os.path.join(script_dir, "secure_server.py")],
        env=None
    )

    # ===========================================
    # MCP í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ì‹œì‘
    # ===========================================
    async with stdio_client(server_params) as (read, write):
        async with ClientSession(read, write) as session:
            # MCP í”„ë¡œí† ì½œ í•¸ë“œì…°ì´í¬
            await session.initialize()

            # ===========================================
            # í…ŒìŠ¤íŠ¸ 1: ì •ìƒ ë¡œê·¸ì¸
            # ===========================================
            print("\nğŸ“ í…ŒìŠ¤íŠ¸ 1: ì •ìƒ ë¡œê·¸ì¸")
            print("-" * 70)

            # ì •ìƒ ì…ë ¥:
            # - username: "alice" (ìœ íš¨í•œ í˜•ì‹, ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ì)
            # - password: "alice123" (ì˜¬ë°”ë¥¸ ë¹„ë°€ë²ˆí˜¸)
            #
            # ë³´ì•ˆ ì„œë²„ì˜ ì²˜ë¦¬:
            # 1. validate_username("alice") â†’ True (ì˜ë¬¸ìë§Œ)
            # 2. Prepared Statement ì‹¤í–‰
            # 3. ë¡œê·¸ì¸ ì„±ê³µ
            result = await session.call_tool("login", arguments={
                "username": "alice",
                "password": "alice123"
            })
            print(f"ê²°ê³¼: {result.content[0].text}")

            # ===========================================
            # í…ŒìŠ¤íŠ¸ 2: ì‚¬ìš©ì ê²€ìƒ‰
            # ===========================================
            print("\nğŸ“ í…ŒìŠ¤íŠ¸ 2: ì‚¬ìš©ì ê²€ìƒ‰")
            print("-" * 70)

            # ì •ìƒ ì…ë ¥:
            # - username: "bob" (ìœ íš¨í•œ í˜•ì‹)
            #
            # ë³´ì•ˆ ì„œë²„ì˜ ì²˜ë¦¬:
            # 1. validate_username("bob") â†’ True
            # 2. LIKE íŒ¨í„´ ìƒì„±: "%bob%"
            # 3. Prepared Statementë¡œ ê²€ìƒ‰
            # 4. bobì„ í¬í•¨í•˜ëŠ” ì‚¬ìš©ì ë°˜í™˜
            result = await session.call_tool("search_user", arguments={
                "username": "bob"
            })
            print(f"ê²°ê³¼: {result.content[0].text}")

            # ===========================================
            # í…ŒìŠ¤íŠ¸ 3: ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
            # ===========================================
            print("\nğŸ“ í…ŒìŠ¤íŠ¸ 3: ì‚¬ìš©ì IDë¡œ ì¡°íšŒ")
            print("-" * 70)

            # ì •ìƒ ì…ë ¥:
            # - user_id: "2" (ìœ íš¨í•œ ìˆ«ì í˜•ì‹)
            #
            # ë³´ì•ˆ ì„œë²„ì˜ ì²˜ë¦¬:
            # 1. validate_user_id("2") â†’ True (int ë³€í™˜ ì„±ê³µ)
            # 2. Prepared Statementë¡œ ì¡°íšŒ
            # 3. ID=2 ì‚¬ìš©ì ì •ë³´ ë°˜í™˜ (alice)
            result = await session.call_tool("get_user_info", arguments={
                "user_id": "2"
            })
            print(f"ê²°ê³¼: {result.content[0].text}")

            # ===========================================
            # í…ŒìŠ¤íŠ¸ 4: ì´ë©”ì¼ ì—…ë°ì´íŠ¸
            # ===========================================
            print("\nğŸ“ í…ŒìŠ¤íŠ¸ 4: ì´ë©”ì¼ ì—…ë°ì´íŠ¸")
            print("-" * 70)

            # ì •ìƒ ì…ë ¥:
            # - username: "alice" (ìœ íš¨í•œ í˜•ì‹)
            # - new_email: "alice.secure@example.com" (ìœ íš¨í•œ ì´ë©”ì¼)
            #
            # ë³´ì•ˆ ì„œë²„ì˜ ì²˜ë¦¬:
            # 1. validate_username("alice") â†’ True
            # 2. validate_email("alice.secure@example.com") â†’ True
            # 3. Prepared Statementë¡œ UPDATE
            # 4. aliceì˜ ì´ë©”ì¼ ë³€ê²½ ì„±ê³µ
            result = await session.call_tool("update_email", arguments={
                "username": "alice",
                "new_email": "alice.secure@example.com"
            })
            print(f"ê²°ê³¼: {result.content[0].text}")

            # ===========================================
            # í…ŒìŠ¤íŠ¸ 5: ì—…ë°ì´íŠ¸ í™•ì¸
            # ===========================================
            print("\nğŸ“ í…ŒìŠ¤íŠ¸ 5: ì—…ë°ì´íŠ¸ í™•ì¸")
            print("-" * 70)

            # aliceë¥¼ ë‹¤ì‹œ ê²€ìƒ‰í•˜ì—¬ ì´ë©”ì¼ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
            # ë³´ì•ˆ ì„œë²„ì—ì„œë„ ì •ìƒ ë™ì‘í•¨ì„ í™•ì¸
            result = await session.call_tool("search_user", arguments={
                "username": "alice"
            })
            print(f"ê²°ê³¼: {result.content[0].text}")

    # ===========================================
    # í…ŒìŠ¤íŠ¸ ì™„ë£Œ
    # ===========================================
    print("\n" + "=" * 70)
    print("âœ… ëª¨ë“  ì •ìƒ í…ŒìŠ¤íŠ¸ ì™„ë£Œ")
    print("=" * 70)
    print("\nê´€ì°° ì‚¬í•­:")
    print("- ë³´ì•ˆ ì„œë²„ëŠ” ì •ìƒ ì…ë ¥ì„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤")
    print("- Prepared Statementì™€ ì…ë ¥ ê²€ì¦ì´ ì •ìƒ ë™ì‘ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤")
    print("- test_vulnerable_server.pyì™€ ë™ì¼í•œ ê²°ê³¼ë¥¼ ì–»ìŠµë‹ˆë‹¤")
    print("\në‹¤ìŒ ë‹¨ê³„:")
    print("- secure_attack_simulation.pyë¥¼ ì‹¤í–‰í•˜ì—¬ ê³µê²© ì°¨ë‹¨ í™•ì¸")
    print("- attack_simulation.pyì™€ ë¹„êµí•˜ì—¬ ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜ ì´í•´")

    # ì¶œë ¥ ë²„í¼ flush (ëª¨ë“  ë©”ì‹œì§€ê°€ í™•ì‹¤íˆ ì¶œë ¥ë˜ë„ë¡)
    sys.stdout.flush()

# ===========================================
# í”„ë¡œê·¸ë¨ ì§„ì…ì 
# ===========================================

if __name__ == "__main__":
    """
    ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ ì‹¤í–‰ë  ë•Œë§Œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

    ì‹¤í–‰ ë°©ë²•:
    python3 test_secure_server.py

    ë˜ëŠ” Docker í™˜ê²½:
    make shell python3 Part2_SQLInjection/WithSQLDefense/test_secure_server.py

    ê¸°ëŒ€ ê²°ê³¼:
    - ëª¨ë“  ì •ìƒ ì…ë ¥ì´ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬ë¨
    - ë³´ì•ˆ ê¸°ëŠ¥ì´ ì •ìƒ ë™ì‘ì„ ë°©í•´í•˜ì§€ ì•ŠìŒ
    - test_vulnerable_server.pyì™€ ë™ì¼í•œ ì¶œë ¥
    """
    asyncio.run(test_secure_server())


# ===========================================
# í•™ìŠµ ì •ë¦¬
# ===========================================
"""
ì´ íŒŒì¼ì—ì„œ ë°°ìš´ ë‚´ìš©:

1. ë³´ì•ˆ ì„œë²„ì˜ ì •ìƒ ë™ì‘
   - Prepared StatementëŠ” ì •ìƒ ì…ë ¥ì„ ë°©í•´í•˜ì§€ ì•ŠìŒ
   - ì…ë ¥ ê²€ì¦ë„ ìœ íš¨í•œ ì…ë ¥ì€ í†µê³¼ì‹œí‚´
   - ì‚¬ìš©ì ê²½í—˜ì— ì˜í–¥ ì—†ìŒ

2. ì •ìƒ vs ê³µê²© ì…ë ¥ì˜ ì°¨ì´
   - ì •ìƒ: "alice", "bob", "alice123"
   - ê³µê²©: "admin' OR '1'='1", "1 UNION SELECT ..."
   - ë³´ì•ˆ ì„œë²„ëŠ” ì „ìëŠ” í—ˆìš©, í›„ìëŠ” ì°¨ë‹¨

3. ë¹„êµ í•™ìŠµì˜ ì¤‘ìš”ì„±
   - test_vulnerable_server.py: ì •ìƒ ë™ì‘ (í•˜ì§€ë§Œ ì·¨ì•½)
   - test_secure_server.py: ì •ìƒ ë™ì‘ (ë³´ì•ˆ ì ìš©)
   - ë‘ íŒŒì¼ ëª¨ë‘ ê°™ì€ ê²°ê³¼ë¥¼ ìƒì„±
   - ì°¨ì´ëŠ” ê³µê²© ì‹œë„ ì‹œ ë‚˜íƒ€ë‚¨

4. ë‹¤ìŒ í•™ìŠµ ë‹¨ê³„
   - secure_attack_simulation.py ì‹¤í–‰
   - attack_simulation.pyì™€ ë¹„êµ
   - ì™œ ê°™ì€ ê³µê²©ì´ í•˜ë‚˜ëŠ” ì„±ê³µí•˜ê³  í•˜ë‚˜ëŠ” ì‹¤íŒ¨í•˜ëŠ”ì§€ ë¶„ì„
   - ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜ì˜ ì›ë¦¬ ì´í•´

í•µì‹¬ ë©”ì‹œì§€:
ë³´ì•ˆì€ ì •ìƒ ê¸°ëŠ¥ì„ í•´ì¹˜ì§€ ì•Šìœ¼ë©´ì„œ
ê³µê²©ë§Œ ì„ íƒì ìœ¼ë¡œ ì°¨ë‹¨í•´ì•¼ í•©ë‹ˆë‹¤!
"""
