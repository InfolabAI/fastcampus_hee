# ν•„μ”ν• λΌμ΄λΈλ¬λ¦¬μ™€ ν΄λμ¤λ¥Ό κ°€μ Έμµλ‹λ‹¤.
import asyncio  # λΉ„λ™κΈ° μ‘μ—…μ„ μ„ν• λΌμ΄λΈλ¬λ¦¬
from fastmcp import Client  # FastMCP ν΄λΌμ΄μ–ΈνΈ μƒμ„± ν΄λμ¤
from fastmcp.client.transports import StdioTransport  # STDIO ν†µμ‹ μ„ μ„ν• ν΄λμ¤

async def test_secure_server_proxy():
    """
    `secure_http_server_proxy.py`λ¥Ό ν†µν•΄ λ³΄μ• μ„λ²„μ™€ ν†µμ‹ ν•λ” ν…μ¤νΈλ¥Ό μν–‰ν•©λ‹λ‹¤.
    μ΄ ν΄λΌμ΄μ–ΈνΈλ” JWT ν† ν°μ„ μ§μ ‘ λ‹¤λ£¨μ§€ μ•μΌλ©°, λ¨λ“  μΈμ¦ μ²λ¦¬λ” ν”„λ΅μ‹κ°€ λ‹΄λ‹Ήν•©λ‹λ‹¤.
    """
    
    print("=== λ³΄μ• μ„λ²„ ν”„λ΅μ‹ ν†µμ‹  ν…μ¤νΈ ===\n")
    
    # --- StdioTransport μ„¤μ • ---
    # `secure_http_server_proxy.py` μ¤ν¬λ¦½νΈλ¥Ό μμ‹ ν”„λ΅μ„Έμ¤λ΅ μ‹¤ν–‰ν•κ³ ,
    # ν‘μ¤€ μ…μ¶λ ¥(STDIO)μ„ ν†µν•΄ ν†µμ‹ ν•λ” Transportλ¥Ό μ„¤μ •ν•©λ‹λ‹¤.
    transport = StdioTransport(
        command="python",  # μ‹¤ν–‰ν•  λ…λ Ήμ–΄
        args=["secure_http_server_proxy.py"]  # λ…λ Ήμ–΄μ— μ „λ‹¬ν•  μΈμ
    )
    
    # --- MCP ν΄λΌμ΄μ–ΈνΈ μƒμ„± ---
    # μ„μ—μ„ μ„¤μ •ν• StdioTransportλ¥Ό μ‚¬μ©ν•μ—¬ MCP ν΄λΌμ΄μ–ΈνΈλ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    # μ΄ ν΄λΌμ΄μ–ΈνΈλ” μ΄μ  `secure_http_server_proxy.py` ν”„λ΅μ„Έμ¤μ™€ ν†µμ‹ ν•©λ‹λ‹¤.
    client = Client(transport)
    
    try:
        # `async with client:` κµ¬λ¬Έμ„ μ‚¬μ©ν•μ—¬ ν΄λΌμ΄μ–ΈνΈ μ—°κ²°μ„ μ‹μ‘ν•κ³ ,
        # λΈ”λ΅μ΄ λλ‚λ©΄ μλ™μΌλ΅ μ—°κ²°μ„ μΆ…λ£ν•©λ‹λ‹¤.
        async with client:
            print("β… λ³΄μ• μ„λ²„ ν”„λ΅μ‹ μ—°κ²° μ„±κ³µ!")
            print("   ν”„λ΅μ‹κ°€ JWT μΈμ¦μ„ μλ™μΌλ΅ μ²λ¦¬ν•©λ‹λ‹¤.\n")
            
            # --- 1λ‹¨κ³„: μ‚¬μ© κ°€λ¥ν• λ„κµ¬ λ©λ΅ ν™•μΈ ---
            # ν”„λ΅μ‹λ¥Ό ν†µν•΄ μ‹¤μ  μ„λ²„μ λ„κµ¬ λ©λ΅μ„ κ°€μ Έμµλ‹λ‹¤.
            print("π“‹ 1λ‹¨κ³„: μ‚¬μ© κ°€λ¥ν• λ„κµ¬ λ©λ΅")
            tools = await client.list_tools()
            for tool in tools:
                print(f"   - {tool.name}: {tool.description}")
            print()
            
            # --- 2λ‹¨κ³„: λ³΄νΈλ 'add' λ„κµ¬ νΈμ¶ ---
            # μ΄ ν΄λΌμ΄μ–ΈνΈλ” JWT ν† ν° μ—†μ΄ `call_tool`μ„ νΈμ¶ν•©λ‹λ‹¤.
            # μ”μ²­μ„ λ°›μ€ ν”„λ΅μ‹κ°€ μλ™μΌλ΅ JWT ν† ν°μ„ ν—¤λ”μ— μ¶”κ°€ν•μ—¬
            # μ‹¤μ  μ„λ²„λ΅ μ „λ‹¬ν•λ―€λ΅, μΈμ¦μ΄ μ„±κ³µμ μΌλ΅ μ™„λ£λ©λ‹λ‹¤.
            print("π“‹ 2λ‹¨κ³„: λ³΄νΈλ add λ„κµ¬ νΈμ¶ (JWT μλ™ μΈμ¦)")
            result = await client.call_tool("add", {"a": 42, "b": 58})
            print(f"   β… κ³„μ‚° κ²°κ³Ό: 42 + 58 = {result}")
            print("   JWT ν† ν°μ΄ ν”„λ΅μ‹μ— μν•΄ μλ™μΌλ΅ μ¶”κ°€λμ—μµλ‹λ‹¤.")
            print()
            
            # --- 3λ‹¨κ³„: λ³΄νΈλ 'create_greeting' λ„κµ¬ νΈμ¶ ---
            # λ§μ°¬κ°€μ§€λ΅ ν”„λ΅μ‹κ°€ μΈμ¦μ„ ν¬λ…ν•κ² μ²λ¦¬ν•΄ μ¤λ‹λ‹¤.
            print("π“‹ 3λ‹¨κ³„: λ³΄νΈλ create_greeting λ„κµ¬ νΈμ¶ (JWT μλ™ μΈμ¦)")
            greeting = await client.call_tool("create_greeting", {"name": "Secure User"})
            print(f"   β… μΈμ‚¬λ§: {greeting}")
            print("   JWT ν† ν°μ΄ ν”„λ΅μ‹μ— μν•΄ μλ™μΌλ΅ μ¶”κ°€λμ—μµλ‹λ‹¤.")
            print()
            
            # --- 4λ‹¨κ³„: μ—°μ† μ”μ²­ ν…μ¤νΈ ---
            # μ—¬λ¬ λ²μ μ”μ²­λ„ λ¬Έμ μ—†μ΄ μ²λ¦¬λλ”μ§€ ν™•μΈν•©λ‹λ‹¤.
            print("π“‹ 4λ‹¨κ³„: μ—°μ† μ”μ²­ ν…μ¤νΈ")
            for i in range(3):
                result = await client.call_tool("add", {"a": i*10, "b": i*5})
                print(f"   μ”μ²­ {i+1}: {i*10} + {i*5} = {result} β…")
            print()
            
            # --- μµμΆ… κ²°κ³Ό λ° μ¥μ  μ”μ•½ ---
            print("π― ν”„λ΅μ‹ ν†µμ‹  ν…μ¤νΈ κ²°κ³Ό:")
            print("   β… ν”„λ΅μ‹λ¥Ό ν†µν•΄ JWT μΈμ¦μ΄ ν¬λ…ν•κ² μ²λ¦¬λ¨")
            print("   β… ν΄λΌμ΄μ–ΈνΈλ” JWT ν† ν°μ„ μ§μ ‘ κ΄€λ¦¬ν•  ν•„μ” μ—†μ")
            print("   β… λ¨λ“  λ³΄νΈλ λ„κµ¬μ— μ •μƒ μ ‘κ·Ό κ°€λ¥")
            print("   β… μ—°μ† μ”μ²­μ΄ μ•μ •μ μΌλ΅ μ²λ¦¬λ¨")
            
            print("\nπ“ JWT ν”„λ΅μ‹ ν¨ν„΄μ μ¥μ :")
            print("   π” ν΄λΌμ΄μ–ΈνΈ μ½”λ“ λ‹¨μν™”: JWT μ²λ¦¬ λ΅μ§ λ¶ν•„μ”")
            print("   π” μ¤‘μ•™ν™”λ μΈμ¦: ν”„λ΅μ‹μ—μ„ ν† ν° κ΄€λ¦¬")
            print("   π” λ³΄μ• λ¶„λ¦¬: λΉ„μ¦λ‹μ¤ λ΅μ§κ³Ό μΈμ¦ λ΅μ§ λ¶„λ¦¬")
            print("   π” ν¬λ…ν• λ³΄μ•: κΈ°μ΅΄ MCP ν΄λΌμ΄μ–ΈνΈ μ½”λ“ λ³€κ²½ μ—†μ")
            
    except Exception as e:
        # ν”„λ΅μ‹ μ—°κ²° λλ” ν†µμ‹  μ¤‘ μ¤λ¥ λ°μƒ μ‹ λ©”μ‹μ§€λ¥Ό μ¶λ ¥ν•©λ‹λ‹¤.
        print(f"β ν”„λ΅μ‹ μ—°κ²° μ‹¤ν¨: {e}")
        print("λ‹¤μμ„ ν™•μΈν•μ„Έμ”:")
        print("1. secure_http_server.pyκ°€ μ‹¤ν–‰ μ¤‘μΈμ§€ ν™•μΈ")
        print("2. secure_http_server_proxy.pyκ°€ μ¬λ°”λ¥΄κ² κµ¬μ„±λμ—λ”μ§€ ν™•μΈ")

# μ΄ μ¤ν¬λ¦½νΈκ°€ μ§μ ‘ μ‹¤ν–‰λ  λ• main ν•¨μ μ—­ν• μ„ ν•λ” λ¶€λ¶„μ…λ‹λ‹¤.
if __name__ == "__main__":
    # asyncio.run()μ„ μ‚¬μ©ν•μ—¬ λΉ„λ™κΈ° ν•¨μμΈ test_secure_server_proxy()λ¥Ό μ‹¤ν–‰ν•©λ‹λ‹¤.
    asyncio.run(test_secure_server_proxy())
